ðŸ”Ž Paste12 â€“ Debug bundle â€” 1755707598


===== 1) Git y rama =====
branch: main
origin	https://github.com/johaneitor/paste12.git (fetch)
origin	https://github.com/johaneitor/paste12.git (push)
 M backend/routes.py
?? backups_1755689326/
?? backups_1755694697/
?? backups_1755703401/
?? backups_1755704186/
?? backups_1755704271/
?? collect_debug_bundle.sh
?? debug_report_1755707598.txt
?? diagnose_feed_and_views.sh
2ce0bee fix(init): sangrÃ­a de enforce_cap_on_boot dentro de create_app()
1f2b10a fix(api): definir _rate_key/_fp antes de limiters; smoke test seguro
290f0e0 chore: trigger render deploy
e93200b fix(viewlog+feed): ViewLog Ãºnico (view_date) + feed paginado + vistas idempotentes
3996593 fix(feed+views): paginaciÃ³n server-side + vistas idempotentes por dÃ­a
HEAD: 2ce0bee81e317710dadc363fd9614397b01e2107


===== 2) Estructura (profundidad 3) =====
.
â”œâ”€â”€ .env
â”œâ”€â”€ .gitattributes
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .paste12.log
â”œâ”€â”€ .paste12.pid
â”œâ”€â”€ .renderignore
â”œâ”€â”€ .renderignore.bak.1755666866
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Procfile
â”œâ”€â”€ VERSION
â”œâ”€â”€ add_actions_menu.sh
â”œâ”€â”€ add_countdown_timer.sh
â”œâ”€â”€ add_reports_and_share.sh
â”œâ”€â”€ add_share_instagram_story.sh
â”œâ”€â”€ add_views_counter.sh
â”œâ”€â”€ audit_paste12.sh
â”œâ”€â”€ backend
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ __init__.py.bad.1751947393
â”‚Â Â  â”œâ”€â”€ __init__.py.bad.1755203442
â”‚Â Â  â”œâ”€â”€ __init__.py.bad.1755277473
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1751947321
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1751947446
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1751947530
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755190113
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755277389
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755547598
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755554997
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755556014
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755640288
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755640408
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755649729
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755661402
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755661704
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755663424
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755663692
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755663855
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755664401
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755664672
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755665041
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755665236
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755665497
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755665827
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755666321
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755666580
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755666866
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755667505
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755667625
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755667781
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755686473
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755686501
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755686722
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755686997
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755705038
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755705134
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755705330
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755705431
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755706308
â”‚Â Â  â”œâ”€â”€ __init__.py.bak.1755706770
â”‚Â Â  â”œâ”€â”€ models.py
â”‚Â Â  â”œâ”€â”€ models.py.1755264206.bak
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755189134
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755461704
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755623473
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755630837
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755637831
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755668927
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755699998
â”‚Â Â  â”œâ”€â”€ models.py.bak.1755702452
â”‚Â Â  â”œâ”€â”€ routes.py
â”‚Â Â  â”œâ”€â”€ routes.py.1755264206.bak
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1751947786
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755189134
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755204230
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755204925
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755461704
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755623473
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755623762
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755627627
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755629635
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755630430
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755630728
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755639793
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755645584
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755649729
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755661402
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755661704
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755668927
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755686473
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755686501
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755686722
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755686997
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755699998
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755702452
â”‚Â Â  â”œâ”€â”€ routes.py.bak.1755705038
â”‚Â Â  â”œâ”€â”€ static_routes.py
â”‚Â Â  â”œâ”€â”€ tasks.py
â”‚Â Â  â””â”€â”€ tasks.py.bak.1755686997
â”œâ”€â”€ backups_1755190274
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â”œâ”€â”€ models.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ backups_1755689326
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ backups_1755694697
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ backups_1755703401
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ models.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ backups_1755704186
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ backups_1755704271
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ routes.py
â”œâ”€â”€ collect_debug_bundle.sh
â”œâ”€â”€ debug_report_1755707598.txt
â”œâ”€â”€ deploy_to_render.sh
â”œâ”€â”€ diagnose_feed_and_views.sh
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ enable_adsense.sh
â”œâ”€â”€ enable_adsense_min.sh
â”œâ”€â”€ enable_likes_views.sh
â”œâ”€â”€ enable_share_copy_only.sh
â”œâ”€â”€ enforce_cap_everywhere.sh
â”œâ”€â”€ enforce_like_report_once.sh
â”œâ”€â”€ ensure_legal_and_deploy.sh
â”œâ”€â”€ fix_and_push.sh
â”œâ”€â”€ fix_api_and_models.sh
â”œâ”€â”€ fix_backend_api_and_front.sh
â”œâ”€â”€ fix_backend_scheduler.sh
â”œâ”€â”€ fix_blueprint_and_boot.sh
â”œâ”€â”€ fix_boot_frontend.sh
â”œâ”€â”€ fix_core_stack.sh
â”œâ”€â”€ fix_expiration.sh
â”œâ”€â”€ fix_favicon_routes_and_migrate.sh
â”œâ”€â”€ fix_feed_pagination_and_views_idempotent.sh
â”œâ”€â”€ fix_front_root_inline.sh
â”œâ”€â”€ fix_front_routes_indent_safe.sh
â”œâ”€â”€ fix_front_routes_once.sh
â”œâ”€â”€ fix_frontend_render.sh
â”œâ”€â”€ fix_frontend_routes_final.sh
â”œâ”€â”€ fix_future_import_and_cap.sh
â”œâ”€â”€ fix_init_clean.sh
â”œâ”€â”€ fix_init_indent_cap.sh
â”œâ”€â”€ fix_legal_and_story.sh
â”œâ”€â”€ fix_limiter_import.sh
â”œâ”€â”€ fix_models_and_migrate.sh
â”œâ”€â”€ fix_rate_key_and_smoke.sh
â”œâ”€â”€ fix_register_frontend_name.sh
â”œâ”€â”€ fix_register_frontend_order.sh
â”œâ”€â”€ fix_remote_and_push.sh
â”œâ”€â”€ fix_render_db_plan.sh
â”œâ”€â”€ fix_render_legacy_db_plan.sh
â”œâ”€â”€ fix_render_static_and_routes.sh
â”œâ”€â”€ fix_root_404.sh
â”œâ”€â”€ fix_root_404_blueprint.sh
â”œâ”€â”€ fix_root_and_legal.sh
â”œâ”€â”€ fix_routes_and_register_api.sh
â”œâ”€â”€ fix_routes_purge_block.sh
â”œâ”€â”€ fix_schema.sh
â”œâ”€â”€ fix_static_root.sh
â”œâ”€â”€ fix_submit_and_style.sh
â”œâ”€â”€ fix_try_indentation_once.sh
â”œâ”€â”€ fix_viewlog_and_feed.sh
â”œâ”€â”€ fix_warn_and_favicon.sh
â”œâ”€â”€ force_fix_routes_render.sh
â”œâ”€â”€ force_frontend_fix.sh
â”œâ”€â”€ frontend
â”‚Â Â  â”œâ”€â”€ ads.txt
â”‚Â Â  â”œâ”€â”€ css
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.1755264206.bak
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.arcade.bak.1751948495
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1751947786
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755276778
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755277389
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755461704
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755491687
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755547598
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755564574
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755623762
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755643458
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755646281
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.bak.1755659501
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.turq.bak.1751948722
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ styles.css.versus.bak.1751948875
â”‚Â Â  â”‚Â Â  â””â”€â”€ styles.css.versus.bak.1751949528
â”‚Â Â  â”œâ”€â”€ favicon.svg
â”‚Â Â  â”œâ”€â”€ img
â”‚Â Â  â”‚Â Â  â””â”€â”€ og.png
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â”œâ”€â”€ index.html.1755264206.bak
â”‚Â Â  â”œâ”€â”€ index.html.arcade.bak.1751948495
â”‚Â Â  â”œâ”€â”€ index.html.bak.1751947786
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755266570
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755276778
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755277389
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755491687
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755547598
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755554997
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755562548
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755641530
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755643458
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755645584
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755646281
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755659501
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755663424
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755663692
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755667505
â”‚Â Â  â”œâ”€â”€ index.html.bak.1755668927
â”‚Â Â  â”œâ”€â”€ index.html.fix.1755219823
â”‚Â Â  â”œâ”€â”€ index.html.recover.1755266235
â”‚Â Â  â”œâ”€â”€ index.html.turq.bak.1751948722
â”‚Â Â  â”œâ”€â”€ index.html.versus.bak.1751948875
â”‚Â Â  â”œâ”€â”€ index.html.versus.bak.1751949528
â”‚Â Â  â”œâ”€â”€ js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ actions_menu.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.1755264206.bak
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1751947786
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755189134
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755266570
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755276778
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755277389
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755461704
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755491687
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755547598
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755562548
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755564574
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.bak.1755623762
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.js.fix.1755219823
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ client_fp.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hotfix.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ share_enhancer.js
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ stability_patch.js
â”‚Â Â  â”‚Â Â  â””â”€â”€ views_counter.js
â”‚Â Â  â”œâ”€â”€ legal.html
â”‚Â Â  â””â”€â”€ robots.txt
â”œâ”€â”€ hard_fix_init.sh
â”œâ”€â”€ hard_fix_init_clean.sh
â”œâ”€â”€ hard_rewrite_routes.sh
â”œâ”€â”€ harden_like_report.sh
â”œâ”€â”€ harden_views_idempotent.sh
â”œâ”€â”€ hotfix_front_render.sh
â”œâ”€â”€ instance
â”‚Â Â  â”œâ”€â”€ production.db
â”‚Â Â  â”œâ”€â”€ production.db.bak.1755218839
â”‚Â Â  â””â”€â”€ production.db.bak.1755219068
â”œâ”€â”€ limit_notes.sh
â”œâ”€â”€ limit_total_notes_and_index.sh
â”œâ”€â”€ limit_total_notes_and_index_fix.sh
â”œâ”€â”€ migrate_sqlite_to_pg.py
â”œâ”€â”€ migrate_sqlite_to_pg.sh
â”œâ”€â”€ patch_render_db_eof.sh
â”œâ”€â”€ publish_untracked.sh
â”œâ”€â”€ push_to_github.sh
â”œâ”€â”€ pytest.ini
â”œâ”€â”€ quick_fix.sh
â”œâ”€â”€ rebuild_index.sh
â”œâ”€â”€ remove_twitter_popup.sh
â”œâ”€â”€ render.yaml
â”œâ”€â”€ render.yaml.bak.1755485395
â”œâ”€â”€ render.yaml.bak.1755486452
â”œâ”€â”€ repair_models_and_migrate_all.sh
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ requirements.txt.bak.1755190113
â”œâ”€â”€ run.py
â”œâ”€â”€ run.py.bak.1751946901
â”œâ”€â”€ run.py.bak.1751947074
â”œâ”€â”€ sanity_redeploy.sh
â”œâ”€â”€ setup_render.sh
â”œâ”€â”€ show_structure.sh
â”œâ”€â”€ stabilize_feed.sh
â”œâ”€â”€ tests
â”‚Â Â  â””â”€â”€ test_api.py
â”œâ”€â”€ update_and_push.sh
â””â”€â”€ venv
    â”œâ”€â”€ bin
    â”‚Â Â  â”œâ”€â”€ Activate.ps1
    â”‚Â Â  â”œâ”€â”€ activate
    â”‚Â Â  â”œâ”€â”€ activate.csh
    â”‚Â Â  â”œâ”€â”€ activate.fish
    â”‚Â Â  â”œâ”€â”€ dotenv
    â”‚Â Â  â”œâ”€â”€ flask
    â”‚Â Â  â”œâ”€â”€ gunicorn
    â”‚Â Â  â”œâ”€â”€ markdown-it
    â”‚Â Â  â”œâ”€â”€ pip
    â”‚Â Â  â”œâ”€â”€ pip3
    â”‚Â Â  â”œâ”€â”€ pip3.12
    â”‚Â Â  â”œâ”€â”€ pygmentize
    â”‚Â Â  â”œâ”€â”€ python -> /data/data/com.termux/files/usr/bin/python
    â”‚Â Â  â”œâ”€â”€ python3 -> python
    â”‚Â Â  â”œâ”€â”€ python3.12 -> python
    â”‚Â Â  â””â”€â”€ waitress-serve
    â”œâ”€â”€ include
    â”‚Â Â  â”œâ”€â”€ python3.12
    â”‚Â Â  â””â”€â”€ site
    â”œâ”€â”€ lib
    â”‚Â Â  â””â”€â”€ python3.12
    â”œâ”€â”€ lib64 -> lib
    â””â”€â”€ pyvenv.cfg

22 directories, 284 files


===== 3) ValidaciÃ³n sintaxis Python =====


===== 4) Grep rÃ¡pido de backend (paginaciÃ³n/orden/limiter) =====
backend/routes.py:46:        "expires_at": (n.expires_at.isoformat() if n.expires_at else None),
backend/routes.py:47:        "remaining": max(0, int((n.expires_at - now).total_seconds())) if n.expires_at else None,
backend/routes.py:58:@bp.get("/notes")
backend/routes.py:62:        page = max(1, int(request.args.get("page", "1")))
backend/routes.py:66:    q = Note.query.filter(Note.expires_at > now).order_by(Note.timestamp.desc())
backend/routes.py:67:    items = q.offset((page-1)*page_size).limit(page_size).all()
backend/routes.py:78:@limiter.limit("1 per 10 seconds", key_func=_rate_key)
backend/routes.py:79:@limiter.limit("500 per day", key_func=_rate_key)
backend/routes.py:88:    n = Note(text=text, timestamp=now, expires_at=now + timedelta(hours=hours))
backend/__init__.py:1:# backend/__init__.py â€” clean reset: DB + Limiter + API + static frontend
backend/__init__.py:6:from flask_limiter import Limiter
backend/__init__.py:12:limiter = Limiter(key_func=get_remote_address, default_limits=[])
backend/__init__.py:157:                conn.execute(text("CREATE INDEX IF NOT EXISTS ix_note_expires_at ON note (expires_at)"))
backend/__init__.py:158:                conn.execute(text("CREATE INDEX IF NOT EXISTS ix_note_exp_ts ON note (expires_at, timestamp)"))


===== 5) Fragmentos clave de backend/routes.py =====
--- cabecera (1..40) ---
     1	from __future__ import annotations
     2	
     3	import os
     4	from datetime import datetime, timezone, timedelta
     5	
     6	from flask import Blueprint, current_app, jsonify, request
     7	from sqlalchemy.exc import IntegrityError
     8	
     9	from . import db, limiter
    10	from .models import Note, LikeLog, ReportLog, ViewLog
    11	
    12	# Blueprint Ãºnico (no registrar aquÃ­; se registra en create_app)
    13	bp = Blueprint("api", __name__)
    14	
    15	# ===== Helpers =====
    16	def _now():
    17	    return datetime.now(timezone.utc)
    18	
    19	def _fp():
    20	    # prioridad: header -> cookie -> IP
    21	    return (
    22	        request.headers.get("X-Client-Fingerprint")
    23	        or request.cookies.get("fp")
    24	        or request.remote_addr
    25	        or "anon"
    26	    )
    27	
    28	def _rate_key():
    29	    return _fp()
    30	
    31	def _per_page():
    32	    # PAGE_SIZE clamped 10..100 (default 20)
    33	    try:
    34	        v = int(os.getenv("PAGE_SIZE", "20"))
    35	    except Exception:
    36	        v = 20
    37	    v = max(10, min(v, 100))
    38	    return v
    39	
    40	def _note_json(n: Note, now=None):
--- def list_notes (...) ---
     1	from __future__ import annotations
     2	
     3	import os
     4	from datetime import datetime, timezone, timedelta
     5	
     6	from flask import Blueprint, current_app, jsonify, request
     7	from sqlalchemy.exc import IntegrityError
     8	
     9	from . import db, limiter
    10	from .models import Note, LikeLog, ReportLog, ViewLog
    11	
    12	# Blueprint Ãºnico (no registrar aquÃ­; se registra en create_app)
    13	bp = Blueprint("api", __name__)
    14	
    15	# ===== Helpers =====
    16	def _now():
    17	    return datetime.now(timezone.utc)
    18	
    19	def _fp():
    20	    # prioridad: header -> cookie -> IP
    21	    return (
    22	        request.headers.get("X-Client-Fingerprint")
    23	        or request.cookies.get("fp")
    24	        or request.remote_addr
    25	        or "anon"
    26	    )
    27	
    28	def _rate_key():
    29	    return _fp()
    30	
    31	def _per_page():
    32	    # PAGE_SIZE clamped 10..100 (default 20)
    33	    try:
    34	        v = int(os.getenv("PAGE_SIZE", "20"))
    35	    except Exception:
    36	        v = 20
    37	    v = max(10, min(v, 100))
    38	    return v
    39	
    40	def _note_json(n: Note, now=None):
    41	    now = now or _now()
    42	    return {
    43	        "id": n.id,
    44	        "text": n.text,
    45	        "timestamp": (n.timestamp.isoformat() if n.timestamp else None),
    46	        "expires_at": (n.expires_at.isoformat() if n.expires_at else None),
    47	        "remaining": max(0, int((n.expires_at - now).total_seconds())) if n.expires_at else None,
    48	        "likes": int(n.likes or 0),
    49	        "views": int(n.views or 0),
    50	        "reports": int(n.reports or 0),
    51	    }
    52	
    53	# ===== Endpoints =====
    54	@bp.get("/health")
    55	def health():
    56	    return jsonify({"ok": True, "now": _now().isoformat()}), 200
    57	
    58	@bp.get("/notes")


===== 6) Helpers de vista Ãºnica y modelos (ViewLog/Unique) =====
31:    __table_args__ = (db.UniqueConstraint("note_id", "fingerprint", name="uq_like_note_fp"),)
40:    __table_args__ = (db.UniqueConstraint("note_id", "fingerprint", name="uq_report_note_fp"),)
47:class ViewLog(db.Model):
52:    view_date = db.Column(db.Date, nullable=False, index=True)  # dÃ­a UTC
55:        db.UniqueConstraint("note_id", "fingerprint", "view_date", name="uq_view_note_fp_day"),


===== 7) Frontend: carga paginada y llamadas =====
61:    const r = await fetch("/api/notes", {
73:    const r = await fetch(`/api/notes/${id}/like`, { method:"POST", headers:{ "X-Client-Token": this.token }});
83:    const r = await fetch(`/api/notes/${id}/report`, { method:"POST", headers:{ "X-Client-Token": this.token }});
120:  async load(page=1){
121:    const r = await fetch(`/api/notes?page=${page}`);
182:      fetch(`/api/notes/${id}/view`, { method:"POST", headers:{ "X-Client-Token": this.token }})


===== 8) Variables de entorno relevantes (local .env y proceso) =====
-- .env --
FLASK_ENV=production
SECRET_KEY=$(openssl rand -hex 32)
RATELIMIT_STORAGE_URL=memory://
ADMIN_TOKEN=changeme
DATABASE_URI=sqlite:///'/data/data/com.termux/files/home/paste12'/instance/production.db
{'PAGE_SIZE': None, 'MAX_PAGE_SIZE': None, 'MAX_NOTES': None, 'DATABASE_URL': None, 'SQLALCHEMY_DATABASE_URI': None}


===== 9) InspecciÃ³n de la app Flask (rutas y blueprint /api) =====
static_folder: /data/data/com.termux/files/home/paste12/frontend

Rutas registradas:
 - /                            | GET                | static_root
 - /<path:filename>             | GET                | static
 - /<path:path>                 | GET                | static_any
 - /ads.txt                     | GET                | static_ads
 - /api/health                  | GET                | api.health
 - /api/notes                   | GET                | api.list_notes
 - /api/notes                   | POST               | api.create_note
 - /api/notes/<int:note_id>/like | POST               | api.like_note
 - /api/notes/<int:note_id>/report | POST               | api.report_note
 - /api/notes/<int:note_id>/view | POST               | api.view_note
 - /favicon.ico                 | GET                | static_favicon

Â¿Existe /api/notes?: True
Â¿Hay blueprint /api?: True


===== 10) Smoke test del feed (test_client) =====
No test_client: module 'werkzeug' has no attribute '__version__'


===== 11) Conteo y orden directo en DB (si se puede) =====
total_notas = 7
newest: ['id=8 ts=2025-08-18 04:45:18.396760 likes=0 views=2', 'id=7 ts=2025-08-18 04:44:46.348683 likes=0 views=2', 'id=6 ts=2025-08-18 04:44:15.936139 likes=1 views=2']
oldest: ['id=1 ts=2025-08-15 00:51:53.572860 likes=13 views=16', 'id=2 ts=2025-08-15 00:52:03.499994 likes=51 views=16', 'id=4 ts=2025-08-16 03:51:01.944308 likes=2 views=9']
