<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Notas</title>
<style>
  :root{
    --bg:#fffdfc; --fg:#24323f; --muted:#6b7a86;
    --teal:#8fd3d0;   /* turquesa pastel */
    --peach:#ffb38a;  /* naranja pastel  */
    --pink:#f9a3c7;   /* rosa pastel     */
    --card:#ffffff; --ring: rgba(36,50,63,.12);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg, var(--bg), #fff); color:var(--fg) }
  header{ position:sticky; top:0; z-index:10; background:linear-gradient(90deg, var(--teal), var(--peach), var(--pink)); color:#17323a; padding:16px 20px; box-shadow:0 2px 12px var(--ring) }
  h1{ margin:0; font-size:clamp(20px,3.2vw,28px) }
  .container{ max-width:860px; margin:20px auto; padding:0 16px }
  .card{ background:var(--card); border:1px solid #eee; border-radius:16px; padding:14px; box-shadow:0 4px 20px var(--ring) }
  textarea, input[type="text"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6eef2; outline:none; font-size:16px; background:#fff; color:var(--fg) }
  textarea:focus, input:focus{ border-color:#b5dfe0; box-shadow:0 0 0 4px rgba(143,211,208,.25) }
  .row{ display:flex; gap:10px; margin-top:10px; align-items:center }
  .btn{ appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; background:linear-gradient(90deg, var(--teal), var(--peach)); color:#14333a; box-shadow:0 6px 18px var(--ring) }
  .btn:active{ transform:translateY(1px) }
  .list{ margin-top:18px; display:grid; gap:12px }
  .note{ background:#fff; border:1px solid #eef2f5; border-radius:14px; padding:12px 14px; position:relative }
  .meta{ color:var(--muted); font-size:12px; margin-top:6px }
  .actions{ display:flex; gap:8px; align-items:center; margin-top:10px }
  .iconbtn{ border:1px solid #e6eef2; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
  .iconbtn:active{ transform:translateY(1px) }
  .menu{ position:relative; margin-left:auto }
  .menu .panel{ position:absolute; right:0; top:34px; background:#fff; border:1px solid #e6eef2; border-radius:10px; box-shadow:0 8px 24px var(--ring); display:none; min-width:160px; overflow:hidden }
  .menu.open .panel{ display:block }
  .menu .panel button{ display:block; width:100%; text-align:left; padding:10px 12px; border:0; background:#fff; cursor:pointer }
  .menu .panel button:hover{ background:#f6fbfb }
  footer{ margin:40px 0 28px; color:var(--muted); text-align:center; font-size:14px }
  footer a{ color:#0b7c8a; text-decoration:underline }
  .hidden{ display:none }
  .error{ color:#9a2b2b; margin-top:8px }
  .ok{ color:#0a6f57; margin-top:8px }
</style>
</head>
<body>
  <header><h1>Notas</h1></header>
  <main class="container">
    <section class="card" id="composer">
      <label for="text" style="font-weight:600;">Escribe tu nota‚Ä¶</label>
      <textarea id="text" rows="3" placeholder="Escribe tu nota‚Ä¶"></textarea>
      <div class="row">
        <input id="ttl" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Horas (12 por defecto)">
        <button id="send" class="btn">Publicar</button>
      </div>
      <div id="msg" class="hidden"></div>
    </section>

    <section class="list" id="list"></section>

    <footer>
      <span>Usamos localStorage (p. ej., para contar vistas una vez).</span>
      <br/>
      <a href="/terms">T√©rminos y Condiciones</a> ¬∑
      <a href="/privacy">Pol√≠tica de Privacidad</a>
    </footer>
  </main>

<script>
const $ = (s)=>document.querySelector(s);
const api = (p)=> (p.startsWith('/')?p:'/api/'+p);
function fmtDate(iso){ try{ return new Date(iso).toLocaleString(); }catch(_){ return iso } }
function itemLink(id){ return location.origin + '/?id=' + id }

function renderItem(it){
  const text = it.text || it.content || it.summary || '';
  return `
    <article class="note" data-id="${it.id}">
      <div>${text?text.replace(/</g,'&lt;'):'(sin texto)'}</div>
      <div class="meta">#${it.id ?? '-'} ¬∑ ${fmtDate(it.timestamp)} ¬∑ ‚ù§ <span class="likes">${it.likes ?? 0}</span> ¬∑ üëÅÔ∏è <span class="views">${it.views ?? 0}</span> ¬∑ üö© <span class="reports">${it.reports ?? 0}</span></div>
      <div class="actions">
        <button class="iconbtn like">‚ù§ Me gusta</button>
        <button class="iconbtn share">üîó Compartir</button>
        <div class="menu">
          <button class="iconbtn more">‚ãØ</button>
          <div class="panel">
            <button class="openlink">Abrir nota</button>
            <button class="copylink">Copiar link</button>
            <button class="report">Reportar</button>
          </div>
        </div>
      </div>
    </article>
  `;
}

function renderList(items){
  const el = $('#list');
  el.innerHTML = (items||[]).map(renderItem).join('') || '<div class="note">No hay notas a√∫n.</div>';
  wireActions();
  markViewsOnce(items||[]);
}

function getId(el){ return parseInt(el.closest('.note').dataset.id,10) }

function wireActions(){
  $('#list').querySelectorAll('.like').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = getId(e.target);
      if(localStorage.getItem('liked_'+id)) return;
      const r = await fetch(api('notes/'+id+'/like'), {method:'POST', headers:{'Accept':'application/json'}});
      const j = await r.json();
      if(j && j.ok){
        localStorage.setItem('liked_'+id,'1');
        const card = e.target.closest('.note');
        card.querySelector('.likes').textContent = j.likes;
      }
    };
  });

  $('#list').querySelectorAll('.share').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = getId(e.target);
      const url = itemLink(id);
      const text = 'Mir√° esta nota #' + id;
      if(navigator.share){
        try{ await navigator.share({title:'Nota #'+id, text, url}); }catch(_){}
      }else{
        try{ await navigator.clipboard.writeText(url); flash('Link copiado ‚úÖ', true);}catch(_){ flash('No se pudo copiar', false); }
      }
    };
  });

  $('#list').querySelectorAll('.menu .more').forEach(btn=>{
    btn.onclick = (e)=>{
      const menu = e.target.closest('.menu');
      menu.classList.toggle('open');
      // cerrar al hacer click fuera
      const closer = (ev)=>{ if(!menu.contains(ev.target)){ menu.classList.remove('open'); document.removeEventListener('click', closer); } };
      setTimeout(()=>document.addEventListener('click', closer), 0);
    };
  });

  $('#list').querySelectorAll('.menu .openlink').forEach(btn=>{
    btn.onclick = (e)=>{ const id = getId(e.target); location.href = itemLink(id); };
  });

  $('#list').querySelectorAll('.menu .copylink').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = getId(e.target); const url = itemLink(id);
      try{ await navigator.clipboard.writeText(url); flash('Link copiado ‚úÖ', true);}catch(_){ flash('No se pudo copiar', false); }
    };
  });

  $('#list').querySelectorAll('.menu .report').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = getId(e.target);
      if(localStorage.getItem('reported_'+id)) return;
      const r = await fetch(api('notes/'+id+'/report'), {method:'POST', headers:{'Accept':'application/json'}});
      const j = await r.json();
      if(j && j.ok){
        localStorage.setItem('reported_'+id,'1');
        const card = e.target.closest('.note');
        card.querySelector('.reports').textContent = j.reports;
        flash('Gracias por reportar', true);
      }
    };
  });
}

async function load(){
  try{
    const r = await fetch(api('notes'), {headers:{'Accept':'application/json'}});
    const j = await r.json();
    renderList(Array.isArray(j)?j : (j.items || []));
  }catch(e){
    $('#list').innerHTML = '<div class="note">Error cargando notas.</div>';
  }
}

function markViewsOnce(items){
  items.forEach(async it=>{
    const id = it.id; if(!id) return;
    const key = 'viewed_'+id;
    if(localStorage.getItem(key)) return;
    try{
      const r = await fetch(api('notes/'+id+'/view'), {method:'POST', headers:{'Accept':'application/json'}});
      const j = await r.json();
      if(j && j.ok){
        localStorage.setItem(key,'1');
        const card = $('#list').querySelector(`.note[data-id="${id}"]`);
        if(card) card.querySelector('.views').textContent = j.views;
      }
    }catch(_){}
  });
}

async function publish(){
  const text = $('#text').value.trim();
  const ttlh = parseInt($('#ttl').value.trim()||'');
  if(!text){ flash('Escrib√≠ algo antes de publicar', false); return }
  try{
    const body = { text };
    if(Number.isFinite(ttlh) && ttlh>0) body.ttl_hours = ttlh;
    const r = await fetch(api('notes'), {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ throw new Error(j.error || 'error') }
    $('#text').value=''; $('#ttl').value='';
    flash('Publicado ‚úÖ', true);
    const it = j.item || null;
    if(it){
      const cur = $('#list').innerHTML;
      $('#list').innerHTML = renderItem(it) + cur;
      wireActions();
      markViewsOnce([it]);
    }else{
      load();
    }
  }catch(e){ console.error(e); flash('No se pudo publicar', false); }
}

function flash(msg, ok){
  const el = $('#msg');
  el.className = ok ? 'ok' : 'error';
  el.textContent = msg;
  setTimeout(()=>{ el.className='hidden'; el.textContent=''; }, 2000);
}

$('#send').addEventListener('click', publish);
$('#text').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ publish(); }});

async function loadSingle(id){
  try{
    const r = await fetch(api('notes/'+id), {headers:{'Accept':'application/json'}});
    const j = await r.json();
    if(j && j.ok && j.item){
      renderList([j.item]);
      markViewsOnce([j.item]);
    }else{
      $('#list').innerHTML = '<div class="note">Nota no encontrada.</div>';
    }
  }catch(_){
    $('#list').innerHTML = '<div class="note">Error cargando la nota.</div>';
  }
}

window.addEventListener('DOMContentLoaded', ()=>{
  // autocompletar con ?text=
  const u = new URL(location.href);
  const pre = u.searchParams.get('text'); if(pre){ $('#text').value = pre; }
  const id = u.searchParams.get('id');
  if(id){ $('#composer').classList.add('hidden'); loadSingle(id); }
  else { load(); }
});
</script>
</body>
</html>
