<!doctype html>
<html lang="es">
<head>
  <meta name="p12-v7" content="1">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paste12</title>
<style>
<!-- p12:cohesion v7 -->
<meta name="p12-cohesion" content="v7">
<script id="p12-nosw" data-nosw>if(location.search.includes("nosw=1")&&"serviceWorker" in navigator){navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});}</script>
<script id="p12-cohesion-v7">
(()=>{try{
  const qs=new URLSearchParams(location.search);
  if(qs.get("nosw")==="1" && "serviceWorker" in navigator){
    navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});
  }
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const api = {
    json: (u,opts={})=>fetch(u, Object.assign({headers:{"Accept":"application/json"}},opts)),
    post: (u,body,ctype)=>fetch(u,{method:"POST",headers:{"Content-Type":ctype},body}),
  };
  async function publish(text){
    if(!text || text.trim().length<12) throw new Error("text_required");
    // intento JSON primero
    const r = await api.json("/api/notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})});
    if(r.ok){ return await r.json(); }
    // fallback a x-www-form-urlencoded
    const r2 = await api.post("/api/notes", new URLSearchParams({text}).toString(),"application/x-www-form-urlencoded");
    return await r2.json();
  }
  async function like(id){ const r=await api.post(`/api/notes/${id}/like`,"","text/plain"); return await r.json(); }
  async function view(id){ const r=await api.post(`/api/notes/${id}/view`,"","text/plain"); return await r.json(); }
  async function report(id){ const r=await api.post(`/api/notes/${id}/report`,"","text/plain"); return await r.json(); }
  async function list(url){
    const r=await api.json(url);
    const link=r.headers.get("Link"); let next=null;
    if(link){ const m=/<([^>]+)>\s*;\s*rel="next"/i.exec(link); if(m) next=m[1]; }
    const j=await r.json(); return {items:(j.items||[]), next};
  }
  function card(n){
    const id=n.id, t=(n.text||"").replace(/</g,"&lt;");
    return `<article class="note" data-id="${id}">
      <p class="text">${t}</p>
      <nav class="actions" data-id="${id}">
        <button data-action="like">❤️ <span class="v-like">${n.likes||0}</span></button>
        <button data-action="view">👁️ <span class="v-view">${n.views||0}</span></button>
        <button data-action="report">🚩</button>
        <a data-action="share" href="/?id=${id}" rel="noopener">Compartir</a>
      </nav>
    </article>`;
  }
  async function renderFeed(startUrl){
    const cont = document.getElementById("notes") || (function(){const d=document.createElement("div"); d.id="notes"; document.body.appendChild(d); return d;})();
    let url = startUrl, pages=0;
    const add = async () => {
      const {items,next}=await list(url);
      cont.insertAdjacentHTML("beforeend", items.map(card).join("") || "<p class='empty'>Sin notas</p>");
      url = next || null; pages++;
      const btn = $("#ver-mas") || (function(){const b=document.createElement("button"); b.id="ver-mas"; b.textContent="Ver más"; document.body.appendChild(b); return b;})();
      btn.style.display = url ? "inline-block" : "none";
      if(!btn._bound){ btn._bound=true; btn.addEventListener("click", e=>{ if(url){ add(); } }); }
      // observar vistas (una vez por nota)
      const io = new IntersectionObserver(ents=>{
        ents.forEach(en=>{
          if(en.isIntersecting){
            const a=en.target; const id=a.getAttribute("data-id");
            if(id && !a._viewed){ a._viewed=true; view(id).then(v=>{
              const s=a.querySelector(".v-view"); if(s) s.textContent = (v.views ?? +s.textContent || 0);
            }).catch(()=>{}); }
          }
        });
      },{rootMargin:"0px 0px -40% 0px"});
      $$(".note").forEach(n=>!n._io && (io.observe(n), n._io=io));
    };
    await add();
  }
  // delegación de acciones
  document.addEventListener("click", e=>{
    const a = e.target.closest("[data-action]");
    if(!a) return;
    const act = a.getAttribute("data-action");
    const holder = a.closest("[data-id]"); const id = holder && holder.getAttribute("data-id");
    if(act==="like" && id){ e.preventDefault(); like(id).then(d=>{ const s=holder.querySelector(".v-like"); if(s) s.textContent = d.likes ?? +s.textContent || 0; }).catch(()=>{}); }
    if(act==="view" && id){ e.preventDefault(); view(id).then(d=>{ const s=holder.querySelector(".v-view"); if(s) s.textContent = d.views ?? +s.textContent || 0; }).catch(()=>{}); }
    if(act==="report" && id){ e.preventDefault(); report(id).catch(()=>{}); }
    if(act==="share" && id){ /* dejar el href */ }
  });

  // publicar (si hay form#new-note o textarea#text)
  const form = document.querySelector("form#new-note") || document.body;
  function pickText(){ return (document.getElementById("text") && document.getElementById("text").value) || ""; }
  if(form && !form._p12){
    form._p12 = true;
    form.addEventListener("submit", async (e)=>{
      if(e.target && e.target.matches("form#new-note")) e.preventDefault();
      try{
        const t = pickText(); const r = await publish(t);
        if(r && r.item){ location.href='/?id='+r.item.id+'&nosw=1'; }
      }catch(err){ console.log("publish failed", err); }
    }, true);
  }

  // modo nota única: /?id=NNN
  const noteId = qs.get("id") || qs.get("note");
  if(noteId && /^\d+$/.test(noteId)){
    const ctn = document.getElementById("notes") || document.body;
    fetch(`/api/notes/${noteId}`).then(r=>r.json()).then(j=>{
      if(j && j.ok && j.item){ ctn.innerHTML = card(j.item); }
      else { ctn.innerHTML = "<p>No encontrada</p>"; }
    }).catch(()=>{});
  }else{
    renderFeed("/api/notes?limit=5").catch(()=>{});
  }
}catch(e){ console.log("p12 v7 shim err", e); }})();
</script>

<script id="p12-safe-shim-v8">
(()=>{try{
  const Q = new URLSearchParams(location.search);
  // nosw: desregistrar SW y limpiar caches
  if (Q.has('nosw') && 'serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));
    if (window.caches) { caches.keys().then(ks=>ks.forEach(k=>caches.delete(k))); }
  }

  const escapeHtml = s=>String(s).replace(/[&<>"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
  const api = {
    list: async (url='/api/notes?limit=10')=>{
      const r = await fetch(url, {credentials:'include'});
      const link = r.headers.get('Link')||'';
      const data = await r.json().catch(()=>({ok:false}));
      return {data, link};
    },
    create: async (text)=>{
      let res = await fetch('/api/notes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      if (res.status===400) {
        res = await fetch('/api/notes',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({text}).toString()});
      }
      return res;
    },
    like: (id)=>fetch(`/api/notes/${id}/like`,{method:'POST'}).then(r=>r.json()).catch(()=>null),
    view: (id)=>fetch(`/api/notes/${id}/view`,{method:'POST'}).catch(()=>{}),
    get:  (id)=>fetch(`/api/notes/${id}`).then(r=>r.json()).catch(()=>null),
    nextFromLink: (link)=>{
      const m = /<([^>]+)>;\s*rel="next"/.exec(link||''); return m? m[1]: null;
    }
  };

  const feedHost = document.querySelector('[data-feed], #feed, main, body') || document.body;
  let feed = document.querySelector('#p12-feed');
  if (!feed) { feed = document.createElement('div'); feed.id = 'p12-feed'; feedHost.appendChild(feed); }

  const makeCard = (it)=>{
    const el = document.createElement('article');
    el.className = 'note-card';
    el.setAttribute('data-id', it.id);
    el.innerHTML = `
      <div class="note-body">${escapeHtml(it.text||'')}</div>
      <div class="note-meta">
        <button data-act="like" aria-label="Me gusta">❤️ <span class="likes">${it.likes||0}</span></button>
        <button data-act="share" aria-label="Compartir">🔗</button>
        <button data-act="report" aria-label="Reportar">🚩</button>
      </div>`;
    return el;
  };

  const renderList = (items, append=false)=>{
    if (!append) feed.innerHTML = '';
    const frag = document.createDocumentFragment();
    (items||[]).forEach(it=> frag.appendChild(makeCard(it)));
    feed.appendChild(frag);
    observeViews(feed);
  };

  // Vistas con IO y de-duplicación
  const seen = new Set();
  function observeViews(root){
    if (!('IntersectionObserver' in window)) return;
    const io = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if (e.isIntersecting){
          const id = e.target.getAttribute('data-id');
          if (id && !seen.has(id)) { seen.add(id); api.view(id); }
        }
      })
    }, {rootMargin:'0px 0px -25% 0px', threshold:0.25});
    root.querySelectorAll('article.note-card').forEach(el=>io.observe(el));
  }

  // Delegación de eventos (like/share/report)
  document.addEventListener('click', async ev=>{
    const btn = ev.target.closest('[data-act]');
    if (!btn) return;
    const act = btn.getAttribute('data-act');
    const card = btn.closest('article.note-card');
    const id = card && card.getAttribute('data-id');

    if (act==='like' && id){
      btn.disabled = true;
      try {
        const r = await api.like(id);
        const sp = card.querySelector('.likes');
        if (r && sp && r.likes!=null) sp.textContent = r.likes;
      } finally { btn.disabled=false; }
    } else if (act==='share' && id){
      const url = `${location.origin}/?id=${id}`;
      if (navigator.share) { navigator.share({url}).catch(()=>{}); }
      else {
        try { await navigator.clipboard?.writeText(url); btn.textContent='✓'; setTimeout(()=>btn.textContent='🔗',1200); } catch {}
      }
    } else if (act==='report' && id){
      try { await fetch(`/api/notes/${id}/report`, {method:'POST'}); btn.textContent='🚩✓'; } catch {}
    }
  }, {passive:true});

  // Publicar con fallback
  const form = document.querySelector('form#publish, form[action*="/api/notes"]');
  if (form){
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const fd = new FormData(form);
      const text = (fd.get('text')||'').toString();
      if (!text || text.trim().length<20) { alert('Texto muy corto'); return; }
      const res = await api.create(text);
      const data = await res.json().catch(()=>null);
      if (res.ok && data && data.item){ renderList([data.item], true); form.reset(); }
    }, {once:false});
  }

  // Nota única o feed con paginado
  const noteId = Q.get('id');
  if (noteId){
    document.head.insertAdjacentHTML('beforeend','<meta name="p12-single" content="1">');
    api.get(noteId).then(j=>{
      if (j && j.ok && j.item) renderList([j.item], false);
    });
  } else {
    api.list('/api/notes?limit=10').then(({data, link})=>{
      if (data && data.ok && Array.isArray(data.items)) {
        renderList(data.items, false);
        let next = api.nextFromLink(link);
        let lm = document.querySelector('#p12-more');
        if (!lm){ lm = document.createElement('button'); lm.id='p12-more'; lm.textContent='Ver más'; feedHost.appendChild(lm); }
        lm.onclick = async ()=>{
          if (!next){ lm.disabled=true; return; }
          lm.disabled = true;
          const {data, link} = await api.list(next);
          if (data && data.ok && data.items?.length) renderList(data.items, true);
          next = api.nextFromLink(link);
          lm.disabled = false;
          if (!next){ lm.textContent='No hay más'; lm.disabled=true; }
        };
      }
    });
  }

  // Marcador de auditoría
  document.head.insertAdjacentHTML('beforeend','<meta name="p12-safe-shim" content="v8">');
} catch(e){ console.warn('p12-safe-shim-v8 error', e); }})();
</script>
