<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paste12</title>
<style>
.brand{margin:0; font-size:clamp(22px,3.4vw,30px)}
  .tagline{margin:6px 0 0; font-size:14px; color:#17323a; font-weight:600; opacity:.9}

  :root{
    --bg:#fffdfc; --fg:#24323f; --muted:#6b7a86;
    --teal:#8fd3d0;   /* turquesa pastel */
    --peach:#ffb38a;  /* naranja pastel */
    --pink:#f9a3c7;   /* rosa pastel */
    --card:#ffffff; --ring: rgba(36,50,63,.15);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        background:linear-gradient(180deg,var(--bg),#fff); color:var(--fg);}
  header{ position:sticky; top:0; z-index:10;
          background:linear-gradient(90deg,var(--teal),var(--peach),var(--pink));
          color:#17323a; padding:16px 20px; box-shadow:0 2px 12px var(--ring); }
  h1{margin:0; font-size:clamp(20px,3.2vw,28px)}
  .container{max-width:860px; margin:20px auto; padding:0 16px}
  .card{ background:var(--card); border:1px solid #eee; border-radius:16px; padding:14px; box-shadow:0 4px 20px var(--ring);}
  textarea,input[type="text"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6eef2; outline:none; font-size:16px; background:#fff; color:var(--fg);}
  textarea:focus,input:focus{ border-color:#b5dfe0; box-shadow:0 0 0 4px rgba(143,211,208,.25) }
  .row{display:flex; gap:10px; margin-top:10px}
  .btn{ appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
        background:linear-gradient(90deg,var(--teal),var(--peach)); color:#14333a; box-shadow:0 6px 18px var(--ring);}
  .btn:active{transform:translateY(1px)}
  .list{margin-top:18px; display:grid; gap:12px}
  .note{ background:#fff; border:1px solid #eef2f5; border-radius:14px; padding:12px 14px; }
  .meta{ color:var(--muted); font-size:13px; margin-top:6px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .meta .act{ border:0; background:transparent; color:inherit; cursor:pointer; padding:0 6px; border-radius:8px; }
  .meta .act:hover{ background:rgba(0,0,0,.05) }
  .menu{ margin-top:8px; display:flex; gap:8px; }
  .hidden{ display:none }
  .error{ color:#9a2b2b; margin-top:8px }
  .ok{ color:#0a6f57; margin-top:8px }
  footer{ margin:40px 0 28px; color:var(--muted); text-align:center; font-size:14px; }
  footer a{ color:#0b7c8a; text-decoration:underline }
</style>
<!-- TAGLINE-BEGIN -->
<style id="tagline-style">
  #tagline{margin:.25rem 0 0;opacity:.9;line-height:1.25;}
  #tagline .tg-text{font-weight:500;}
</style>
<!-- TAGLINE-END -->

<style>/* summary-enhancer */
.summary-more-btn{font:inherit;font-size:.9em;border:none;background:transparent;color:#0b6;cursor:pointer;padding:0;margin-left:.25rem}
.summary-more-btn:hover{text-decoration:underline}
</style>

<style id="brand-colors">
  :root{
    --brand-teal:#14b8a6;    /* teal-500 */
    --brand-orange:#f97316;  /* orange-500 */
  }
  .brand-gradient{
    background: linear-gradient(90deg, var(--brand-teal), var(--brand-orange));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }
</style>
</head>
<body>
  <header>
    <h1 class="brand-gradient brand">Paste12</h1>
  <h2 id="tagline-rot"></h2>
  <h2 id="tagline-rot"></h2>
  
  <p class="tagline" id="tagline">Reta a un amigo ¬∑ Dime un secreto ¬∑ Confiesa algo ¬∑ Manda un reto ¬∑ An√≥nimo o no, t√∫ decides</p>
  </header>
  <main class="container">
    <section class="card">
      <label for="text" style="font-weight:600;">Escribe tu nota‚Ä¶</label>
      <textarea id="text" rows="3" placeholder="Escribe tu nota‚Ä¶"></textarea>
      <div class="row">
        <input id="ttl" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Horas (12 por defecto)">
        <button id="send" class="btn">Publicar</button>
      </div>
      <div id="msg" class="hidden"></div>
    </section>

    <section class="list" id="list"></section>

    <footer>
      <span>Usamos cookies/localStorage (p. ej., para contar vistas).</span><br/>
      <a href="/terms">T√©rminos y Condiciones</a> ¬∑ <a href="/privacy">Pol√≠tica de Privacidad</a>
    </footer>
  </main>

<script>
const $ = (s)=>document.querySelector(s);
const api = (p)=> (p.startsWith('/')?p:'/api/'+p);

function fmtDate(iso){ try{ return new Date(iso).toLocaleString(); }catch(_){ return iso } }

function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function renderItem(it){
  const text = it.text || it.content || it.summary || '';
  return `
    <article class="note" data-id="${it.id}">
      <div>${text ? esc(text) : '(sin texto)'}</div>
      <div class="meta">
        <span>#${it.id ?? '-'} ¬∑ ${fmtDate(it.timestamp)}</span>
        <button class="act like">‚ù§ <span class="like-count">${it.likes ?? 0}</span></button>
        <span class="views">üëÅÔ∏è <span class="view-count">${it.views ?? 0}</span></span>
        <button class="act more">‚ãØ</button>
      </div>
      <div class="menu hidden">
        <button class="share">Compartir</button>
        <button class="report">Reportar üö©</button>
      </div>
    </article>
  `;
}

function renderList(items){
  $('#list').innerHTML = (items||[]).map(renderItem).join('') || '<div class="note">No hay notas a√∫n.</div>';
}

async function load(){
  try{
    const r = await fetch(api('notes'), {headers:{'Accept':'application/json'}});
    const j = await r.json();
    renderList(Array.isArray(j)?j : (j.items || []));
  }catch(e){
    $('#list').innerHTML = '<div class="note">Error cargando notas.</div>';
  }
}

async function publish(){
  const text = $('#text').value.trim();
  const ttlh = parseInt($('#ttl').value.trim()||'');
  if(!text){ flash('Escrib√≠ algo antes de publicar', false); return }
  try{
    const body = { text };
    if(Number.isFinite(ttlh) && ttlh>0) body.ttl_hours = ttlh;
    const r = await fetch(api('notes'), {
      method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ throw new Error(j.error || 'error') }
    $('#text').value=''; $('#ttl').value='';
    flash('Publicado ‚úÖ', true);
    const it = j.item || null;
    if(it){
      $('#list').insertAdjacentHTML('afterbegin', renderItem(it));
    }else{
      load();
    }
  }catch(e){ console.error(e); flash('No se pudo publicar', false); }
}

function flash(msg, ok){
  const el = $('#msg');
  el.className = ok ? 'ok' : 'error';
  el.textContent = msg;
  setTimeout(()=>{ el.className='hidden'; el.textContent=''; }, 2000);
}

$('#send').addEventListener('click', publish);
$('#text').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ publish(); }});

// Delegaci√≥n de eventos para like / ‚ãØ / compartir / reportar
document.addEventListener('click', async (e)=>{
  const likeBtn = e.target.closest('button.like');
  const moreBtn = e.target.closest('button.more');
  const shareBtn = e.target.closest('.menu .share');
  const reportBtn = e.target.closest('.menu .report');
  const art = e.target.closest('article.note');
  const id = art?.dataset.id;
  if(!art || !id) return;

  try{
    if(likeBtn){
      const r = await fetch(api(`notes/${id}/like`), {method:'POST'});
      const j = await r.json();
      if(j.ok){
        art.querySelector('.like-count').textContent = j.likes;
      }
    }else if(moreBtn){
      art.querySelector('.menu')?.classList.toggle('hidden');
    }else if(shareBtn){
      const url = `${location.origin}/?id=${id}`;
      if(navigator.share){ await navigator.share({title:'Nota', url}); }
      else { await navigator.clipboard.writeText(url); flash('Link copiado', true); }
      art.querySelector('.menu')?.classList.add('hidden');
    }else if(reportBtn){
      const r = await fetch(api(`notes/${id}/report`), {method:'POST'});
      const j = await r.json();
      if(j.ok){
        if(j.removed){ art.remove(); flash('Nota eliminada por reportes', true); }
        else { flash('Reporte enviado', true); }
      }else{
        flash('No se pudo reportar', false);
      }
      art.querySelector('.menu')?.classList.add('hidden');
    }
  }catch(err){
    console.error(err);
    flash('Acci√≥n fallida', false);
  }
});

window.addEventListener('DOMContentLoaded', ()=>{
  const u = new URL(location.href);
  const pre = u.searchParams.get('text'); if(pre){ $('#text').value = pre; }
  load();
});
</script>
<script>
/* view-observer:start */
(function(){
  try{
    const seen = new Set();
    // Cargar vistos previos (limitar a 500 ids para no crecer sin control)
    try {
      (JSON.parse(localStorage.getItem('seen_views')||'[]')||[]).slice(-500).forEach(id=>seen.add(String(id)));
    } catch(_) {}
    const save = () => {
      try { localStorage.setItem('seen_views', JSON.stringify([...seen].slice(-500))); } catch(_){}
    };

    // Fingerprint simple para backend (opcional)
    const fp = (navigator.userAgent||'') + '|' + (navigator.language||'') + '|' +
               (Intl.DateTimeFormat().resolvedOptions().timeZone||'');

    const obs = new IntersectionObserver((entries)=>{
      entries.forEach(async (entry)=>{
        if (!entry.isIntersecting) return;
        const el = entry.target;
        const id = (el.getAttribute('data-id')||'').trim();
        if (!id || seen.has(id)) { obs.unobserve(el); return; }
        seen.add(id); save();
        try{
          const res = await fetch(api('notes/'+id+'/view'), {method:'POST', headers:{'X-FP': fp}});
          let j = {};
          try { j = await res.json(); } catch(_){}
          if (res.ok && (j.ok || j.id)) {
            const span = el.querySelector('.views');
            if (span) {
              const m = /(\d+)/.exec(span.textContent||'0'); const cur = m?parseInt(m[1],10):0;
              span.textContent = 'üëÅÔ∏è ' + (cur+1);
            }
          }
        }catch(_){}
        obs.unobserve(el);
      });
    }, {root: null, threshold: 0.6});

    function attach(){
      document.querySelectorAll('article.note[data-id]').forEach(el=>{
        if (!el.dataset.observing) { el.dataset.observing = '1'; obs.observe(el); }
      });
    }
    const list = document.getElementById('list');
    if (list) {
      const mo = new MutationObserver(attach);
      mo.observe(list, {childList:true});
    }
    // Primera pasada
    attach();
  }catch(_){}
})();
/* view-observer:end */
</script>
<script>
(function(){
  const el = document.getElementById('tagline');
  if(!el) return;
  const lines = [
    "Reta a un amigo",
    "Dime un secreto",
    "Confiesa algo",
    "Manda un reto",
    "An√≥nimo o no, t√∫ decides"
  ];
  let i = Math.floor(Math.random()*lines.length);
  function set(){ el.textContent = lines[i]; i = (i+1) % lines.length; }
  set();
  setInterval(set, 5000);
})();
</script>

<script id="summary-enhancer">
(function(){
  const FEED_SEL = '[data-feed], #feed, .notes, .list, body'; // fallback amplio
  const CARD_SEL = '[data-note-id], .note, .card';
  const TEXT_SEL = 'p, .text, .note-text, [data-text]';
  const MAX = 20;

  function truncate(t, n){ if(!t) return ""; return (t.length<=n)?t:(t.slice(0,n)+'‚Ä¶'); }

  function decorateCard(card){
    if(card.dataset.summaryDecorated==="1") return;
    const tid = card.getAttribute("data-note-id") || card.getAttribute("data-id") || "";
    // encontrar el contenedor de texto m√°s plausible
    const el = card.querySelector(TEXT_SEL);
    if(!el) return;
    // guardar texto completo si no existe
    if(!el.dataset.full){
      el.dataset.full = el.textContent || "";
    }
    // si ya hay summary del backend, √∫salo; si no, lo generamos
    const backendSummary = card.getAttribute("data-summary") || el.getAttribute("data-summary");
    const full = el.dataset.full;
    const summary = backendSummary || truncate(full, MAX);

    // si no hace falta ver m√°s, no agregamos bot√≥n
    const needMore = full.length > summary.length;
    el.textContent = summary;

    // bot√≥n ver m√°s/menos
    let btn = card.querySelector(".summary-more-btn");
    if(!btn && needMore){
      btn = document.createElement("button");
      btn.className = "summary-more-btn";
      btn.type = "button";
      btn.textContent = "Ver m√°s";
      el.insertAdjacentElement("afterend", btn);
      btn.addEventListener("click", (ev)=>{
        const expanded = btn.getAttribute("data-expanded")==="1";
        if(expanded){
          el.textContent = backendSummary || truncate(full, MAX);
          btn.textContent = "Ver m√°s";
          btn.setAttribute("data-expanded","0");
        }else{
          el.textContent = full;
          btn.textContent = "Ver menos";
          btn.setAttribute("data-expanded","1");
        }
      });
    }
    card.dataset.summaryDecorated = "1";
  }

  function scan(){
    const root = document.querySelector(FEED_SEL) || document.body;
    root.querySelectorAll(CARD_SEL).forEach(decorateCard);
  }

  // Primera pasada
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", scan);
  }else{
    scan();
  }

  // Observer para nuevos items
  const mo = new MutationObserver((muts)=>{
    let need=false;
    for(const m of muts){
      if(m.addedNodes && m.addedNodes.length){ need=true; break; }
    }
    if(need) scan();
  });
  try{
    mo.observe(document.body, {childList:true, subtree:true});
  }catch(e){}
})();
</script>


<!-- TAGLINE-ROTATOR -->
<script>
(function(){
  if (window.__taglineRotatorInstalled) return;
  window.__taglineRotatorInstalled = true;

  try {
    var el = document.getElementById('tagline-rot');
    if (!el) return;

    // Frases base (puedes editarlas aqu√≠)
    var phrases = [
      "Reta a un amigo",
      "Dime un secreto",
      "Confiesa algo",
      "Manda un reto",
      "An√≥nimo o no, t√∫ decides"
    ];

    // Si el H2 ya trae texto (por SSR), √∫salo como primer valor
    var initial = (el.textContent || "").trim();
    if (initial && phrases.indexOf(initial) === -1) {
      phrases.unshift(initial);
    }

    var i = 0;
    function tick(){
      el.textContent = phrases[i];
      i = (i + 1) % phrases.length;
    }
    tick();
    // Evitar m√∫ltiple timers si el DOM se hidrata dos veces
    if (!el.dataset.rotStarted){
      el.dataset.rotStarted = "1";
      setInterval(tick, 3500);
    }
  } catch (e) {
    // silencio por seguridad
  }
})();
</script>

<script id="max-pages-guard">
(function(){
  if (window.__MAX_PAGES_GUARD__) return; window.__MAX_PAGES_GUARD__=true;
  const MAX_PAGES = 200;
  let pageCount = 1;
  // Exponer contador por si la UI ya tiene su propio loader
  window.PASTE12_MAX_PAGES = MAX_PAGES;
  window.PASTE12_pageCount = () => pageCount;

  // Interceptar clicks en botones "m√°s" comunes
  function guardMore(evt){
    if (pageCount >= MAX_PAGES) {
      evt && evt.preventDefault();
      console.warn("Max pages reached:", MAX_PAGES);
      const b = evt && evt.currentTarget;
      if (b) { b.setAttribute('disabled',''); b.textContent = "L√≠mite de p√°ginas (200)"; }
      return false;
    }
    pageCount++;
    return true;
  }
  // Delegaci√≥n: botones con clase .act.more (heur√≠stica presente en la UI)
  document.addEventListener('click', function(e){
    const el = e.target.closest && e.target.closest('.act.more');
    if (!el) return;
    if (!guardMore(e)) return;
  }, true);

  // Interceptar fetch de ‚Äúsiguiente p√°gina‚Äù si el frontend usa fetch()
  const _fetch = window.fetch;
  window.fetch = function(url, init){
    try{
      if (typeof url === 'string' && /\/api\/notes\?/.test(url)) {
        if (pageCount >= MAX_PAGES) {
          return Promise.resolve(new Response(JSON.stringify({ok:false,error:"max_pages_reached"}),{
            status: 429, headers: {'Content-Type':'application/json'}
          }));
        }
        pageCount++;
      }
    }catch(_){}
    return _fetch.apply(this, arguments);
  };
})();
</script>

<!-- p12 debug bootstrap -->
<script id="debug-bootstrap-p12">
(function () {
  try {
    var p = new URLSearchParams(location.search);
    if (!p.has('debug')) return;

    // 1) Desregistrar SW antiguos (no rompe si no hay)
    if ('serviceWorker' in navigator) {
      try {
        navigator.serviceWorker.getRegistrations().then(function(rs){
          rs.forEach(function(r){ r.unregister(); });
        });
      } catch (_e) {}
    }

    // 2) UI m√≠nima de diagn√≥stico
    function addBox() {
      var box = document.createElement('div');
      box.style.cssText = 'position:fixed;right:12px;bottom:12px;padding:10px 12px;background:#111;color:#fff;font:12px/1.4 system-ui;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.3);max-width:42ch;z-index:99999';
      box.innerHTML = '<b>p12 debug</b><div id="p12d"></div>';
      document.body.appendChild(box);
      return box.querySelector('#p12d');
    }
    function log(k,v){
      var el = document.createElement('div');
      el.textContent = k + ': ' + v;
      root.appendChild(el);
    }

    var root = addBox();

    // 3) checks r√°pidos
    fetch('/api/health').then(function(r){ log('health', r.status); }).catch(function(){ log('health','ERR'); });

    fetch('/api/deploy-stamp')
      .then(function(r){ return r.json(); })
      .then(function(j){
        var c = ((j && j.deploy && j.deploy.commit) || j.commit || '').slice(0,7);
        var d = ((j && j.deploy && j.deploy.date)   || j.date   || '');
        log('deploy', c + ' @ ' + d);
      })
      .catch(function(){ log('deploy','ERR'); });

    fetch('/api/notes?limit=3', {headers:{'Accept':'application/json'}})
      .then(function(r){ return r.json(); })
      .then(function(j){
        var n = (Array.isArray(j) ? j.length : ((j && j.items && j.items.length) || 0));
        log('notes', n + ' items');
      })
      .catch(function(){ log('notes','ERR'); });

  } catch (_e) {}
})();
</script>


<!-- p12 PE shim (solo ?pe=1) -->
<script id="pe-shim-p12">
(function(){
  try {
    var p = new URLSearchParams(location.search);
    if (!p.has('pe')) return;

    var root = document.createElement('div');
    root.style.cssText = 'margin:16px;padding:12px;border:1px dashed #aaa;border-radius:10px;background:#fafafa';
    root.innerHTML = '<b>PE shim</b> ‚Äî listado m√≠nimo de /api/notes';
    var list = document.createElement('div');
    list.style.cssText = 'margin-top:8px;font:14px system-ui';
    root.appendChild(list);
    (document.body || document.documentElement).appendChild(root);

    fetch('/api/notes?limit=5',{headers:{'Accept':'application/json'}})
      .then(function(r){ return r.json(); })
      .then(function(j){
        var items = (j && j.items) || [];
        if (!items.length) { list.textContent = '(sin items)'; return; }
        var ul = document.createElement('ul');
        items.forEach(function(it){
          var li = document.createElement('li');
          li.textContent = '#'+it.id+': '+(it.text || it.summary || '(sin texto)');
          ul.appendChild(li);
        });
        list.appendChild(ul);
      })
      .catch(function(){ list.textContent = 'error cargando'; });
  } catch (_e) {}
})();
</script>

<script id="p12-client-template" data-ver="2">
(()=>{const $$=(s,sc)=>Array.from((sc||document).querySelectorAll(s));const $=(s,sc)=> (sc||document).querySelector(s);

// --- 0) Bloquear SW + quitar banners de ‚ÄúNueva versi√≥n disponible‚Äù ---
(async function killSW(){
  try{
    if("serviceWorker" in navigator){
      // Evitar nuevos registros
      try{navigator.serviceWorker.register = ()=>Promise.resolve({});}catch{}
      // Desregistrar existentes
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs){ try{ await r.unregister(); }catch{} }
    }
  }catch{}
})();
function killUpdateBanners(){
  const BAD_TXT = [/nueva versi√≥n disponible/i, /actualiza para ver los √∫ltimos cambios/i, /update available/i];
  const nodes = $$('body *');
  for(const el of nodes){
    const t = (el.textContent||"").trim();
    if(!t) continue;
    if(BAD_TXT.some(rx=>rx.test(t))){
      // Quita el contenedor completo si es un toast/banner
      try{ el.closest('[role="alert"], .toast, .snackbar, .banner')?.remove(); }catch{}
      // O al menos ese nodo
      try{ el.remove(); }catch{}
    }
  }
}
killUpdateBanners();
new MutationObserver(()=>killUpdateBanners()).observe(document.documentElement,{childList:true,subtree:true});

// --- 1) Heur√≠sticas para detectar items de nota y el feed correcto ---
function looksLikeNote(el){
  if(!el || !el.textContent) return false;
  const t = el.textContent;
  if(!/#\s?\d{1,10}\b/.test(t)) return false;       // meta tipo ‚Äú#253‚Äù
  // Evita h√©roes: si contiene H1/H2 grande y no hay #id cerca, descartamos
  const hasHero = el.querySelector('h1,h2');
  if(hasHero && !el.querySelector('*:not(h1):not(h2)')) return false;
  return true;
}
function findFeed(){
  // Tomamos todos los contenedores que tengan ‚â•2 hijos que parezcan nota,
  // y nos quedamos con el de mayor ‚Äúscore‚Äù.
  let best=null, bestScore=0;
  const all = $$('main, [data-feed], #notes, .notes, #list, #root, body, .container, .content, .wrapper, .page');
  for(const cand of all){
    const kids = Array.from(cand.children||[]);
    let score=0;
    for(const ch of kids){ if(looksLikeNote(ch)) score++; }
    if(score>bestScore){ best=cand; bestScore=score; }
  }
  // Si no se encontr√≥, fallback al body
  return best || document.body;
}
const feed = findFeed();
if(!feed){ console.warn("[p12] no feed; abort"); return; }

// --- 2) Elegir template real: primer hijo del feed que parezca nota ---
let templateCard = Array.from(feed.children||[]).find(looksLikeNote);
if(templateCard){ templateCard = templateCard.cloneNode(true); }
const seen = new Set();
// Marcar los ya renderizados para no duplicar
(Array.from(feed.querySelectorAll('[data-note-id]'))).forEach(el=>{
  const id = Number(el.getAttribute('data-note-id')); if(Number.isFinite(id)) seen.add(id);
});
(Array.from(feed.children||[])).forEach(el=>{
  const m=/#\s?(\d{1,10})\b/.exec(el.textContent||''); if(m){ const id=Number(m[1]); if(Number.isFinite(id)) seen.add(id); }
});

function findNth(el, sels){ for(const s of sels){ const n=el.querySelector(s); if(n) return n; } return null; }
function fillCard(card, it){
  try{ card.setAttribute('data-note-id', it.id); }catch{}
  // Texto
  const textNode = findNth(card, ['[data-text]', '.text', '.content', 'p', 'div']);
  if(textNode) textNode.textContent = it.text ?? it.title ?? '';
  // Meta
  const meta = findNth(card, ['[data-meta]', '.meta', '.foot', 'small', '.muted']);
  if(meta){
    const parts=[`#${it.id}`];
    const L = (it.likes ?? 0);
    parts.push(String(L));
    if(it.views != null) parts.push(String(it.views));
    meta.textContent = meta.textContent?.replace(/#\s?\d{1,10}.*/,'') || '';
    meta.textContent = `#${it.id} ¬∑ ${new Date(it.timestamp||Date.now()).toLocaleString()} ¬∑ ${L} `;
  }
  // Acciones (fallback si el template no trae)
  let bar = findNth(card, ['.p12-actions', '.actions', '.toolbar']);
  if(!bar){ bar = document.createElement('div'); bar.className='p12-actions';
    bar.style.cssText='display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap'; card.append(bar);
  }
  // LIKE
  let likeBtn = Array.from(card.querySelectorAll('button,a')).find(b=>/‚ù§Ô∏è|like/i.test((b.textContent||'')));
  if(!likeBtn){ likeBtn=document.createElement('button'); likeBtn.type='button'; likeBtn.textContent=`‚ù§Ô∏è ${it.likes??0}`;
    likeBtn.style.cssText='padding:.3rem .6rem;border:1px solid #eee;border-radius:8px;background:#fff;cursor:pointer'; bar.prepend(likeBtn); }
  likeBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault(); likeBtn.disabled=true;
    try{ const r=await fetch(`/api/notes/${it.id}/like`,{method:'POST',credentials:'include'});
         const d=await r.json().catch(()=>({})); const L=d?.likes ?? (it.likes??0)+1; likeBtn.textContent=`‚ù§Ô∏è ${L}`;
    }catch{} finally{ likeBtn.disabled=false; }
  }, {once:false});
  // REPORT
  let repBtn = Array.from(card.querySelectorAll('button,a')).find(b=>/üö©|report/i.test((b.textContent||'')));
  if(!repBtn){ repBtn=document.createElement('button'); repBtn.type='button'; repBtn.textContent='üö© Reportar';
    repBtn.style.cssText='padding:.3rem .6rem;border:1px solid #eee;border-radius:8px;background:#fff;cursor:pointer'; bar.append(repBtn); }
  repBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault(); if(!confirm('¬øReportar esta nota?')) return; repBtn.disabled=true;
    try{ const r=await fetch(`/api/notes/${it.id}/report`,{method:'POST',credentials:'include'});
         const d=await r.json().catch(()=>({})); if(d?.removed){ card.replaceChildren(Object.assign(document.createElement('div'),{textContent:'Nota ocultada por reportes.',style:'color:#b00'})); }
         else if(d?.reports!=null){ repBtn.textContent=`üö© Reportar (${d.reports})`; }
    }catch{} finally{ repBtn.disabled=false; }
  }, {once:false});
  // SHARE
  let shBtn = Array.from(card.querySelectorAll('button,a')).find(b=>/üîó|share|compart/i.test((b.textContent||'')));
  if(!shBtn){ shBtn=document.createElement('button'); shBtn.type='button'; shBtn.textContent='üîó Compartir';
    shBtn.style.cssText='padding:.3rem .6rem;border:1px solid #eee;border-radius:8px;background:#fff;cursor:pointer'; bar.append(shBtn); }
  shBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault(); const url=`${location.origin}/api/notes/${it.id}`; const text=it.text||`Nota #${it.id}`;
    try{ if(navigator.share){ await navigator.share({title:`Nota #${it.id}`, text, url}); }
         else{ await navigator.clipboard.writeText(url); const o=shBtn.textContent; shBtn.textContent='‚úÖ Copiado'; setTimeout(()=>shBtn.textContent=o,1400); } }catch{}
  }, {once:false});
  return card;
}

function renderItems(items,{append=true}={}){
  for(const it of (items||[])){
    const id = Number(it?.id); if(!Number.isFinite(id) || seen.has(id)) continue;
    seen.add(id);
    let card = templateCard ? templateCard.cloneNode(true) : document.createElement('div');
    card = fillCard(card, it);
    append ? feed.append(card) : feed.prepend(card);
  }
}

const moreBtn = (()=>{ let b=document.getElementById('p12-more');
  if(!b){ b=document.createElement('button'); b.id='p12-more'; b.type='button'; b.textContent='Cargar m√°s';
    b.style.cssText='margin:12px 0; padding:.6rem 1rem; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; display:none';
    feed.after(b);
  } return b;
})();

let nextUrl=null;
async function fetchPage(url){
  const res=await fetch(url,{credentials:"include"}); const data=await res.json().catch(()=>({ok:false,error:"json"}));
  if(!res.ok){ console.warn("HTTP",res.status,data?.error); return; }
  renderItems(data.items||[], {append:true});
  // Next por Link:
  nextUrl=null; const link=res.headers.get("Link")||res.headers.get("link");
  if(link){ const m=/<([^>]+)>;\s*rel="?next"?/i.exec(link); if(m) nextUrl=m[1]; }
  // Next por X-Next-Cursor:
  if(!nextUrl){
    try{ const xn=JSON.parse(res.headers.get("X-Next-Cursor")||"null");
         if(xn&&xn.cursor_ts&&xn.cursor_id){ nextUrl=`/api/notes?cursor_ts=${encodeURIComponent(xn.cursor_ts)}&cursor_id=${xn.cursor_id}`; }
    }catch{}
  }
  moreBtn.style.display = nextUrl ? "" : "none";
}

function pickTextarea(){ return document.querySelector('textarea[name=text], #text, textarea'); }
function pickTTL(){ return document.querySelector('select[name=hours], select[name=ttl], input[name=ttl_hours], select'); }
async function publish(ev){
  if(ev&&ev.preventDefault) ev.preventDefault();
  const ta=pickTextarea(); const ttlSel=pickTTL();
  const text=(ta?.value||"").trim(); if(!text){ alert("Escribe algo primero"); return; }
  const payload={text}; if(ttlSel){ const v=Number(ttlSel.value||ttlSel.getAttribute("value")||12); if(Number.isFinite(v)&&v>0) payload.ttl_hours=v; }
  const res=await fetch("/api/notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),credentials:"include"});
  const data=await res.json().catch(()=>({ok:false,error:"json"}));
  if(!res.ok || data?.ok===false){ alert("Error publicando: "+(data?.error||("HTTP "+res.status))); return; }
  try{ ta.value=""; }catch{}
  const it = data.item || {id:data.id,text:payload.text,likes:data.likes||0,timestamp:Date.now()};
  let card = templateCard ? templateCard.cloneNode(true) : document.createElement('div');
  card = fillCard(card, it);
  feed.prepend(card);
}

function bindPublish(){
  const form = document.querySelector("form");
  if(form) form.addEventListener("submit", e=>publish(e));
  const btn = Array.from(document.querySelectorAll("button, input[type=submit]"))
    .find(b=>/publicar|enviar/i.test((b.textContent||b.value||"")));
  if(btn && !btn.form) btn.addEventListener("click", e=>publish(e));
}

function start(){
  bindPublish();
  // S√≥lo a√±adimos p√°ginas siguientes; mantenemos lo renderizado por el server
  fetchPage("/api/notes?limit=10").catch(()=>{});
}
document.addEventListener("DOMContentLoaded", start);
moreBtn.addEventListener("click", ()=>{ if(nextUrl) fetchPage(nextUrl).catch(()=>{}); });

})();
</script>








</body>
</html>
\n<!-- deploy-stamp-banner -->
<script>
(function(){
  var elId = "deploy-stamp-banner";
  if (document.getElementById(elId)) return; // idempotente

  function h(tag, attrs, text){ var e=document.createElement(tag);
    if(attrs){ for(var k in attrs){ e.setAttribute(k, attrs[k]); } }
    if(text){ e.textContent=text; } return e; }

  function show(stamp){
    var bar = h("div", {id: elId, style:
      "position:fixed;left:16px;right:16px;bottom:16px;padding:12px 16px;"+
      "background:#111;color:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.25);"+
      "font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;"+
      "display:flex;gap:12px;align-items:center;z-index:99999;"});
    var msg = h("div", null, "Nueva versi√≥n disponible. Actualiza para ver los √∫ltimos cambios.");
    var btn = h("button", {style:
      "margin-left:auto;background:#00b894;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer;"+
      "font-weight:600;"}, "Actualizar");
    btn.onclick = function(){
      try { localStorage.setItem("deployStamp", stamp || ""); } catch(_) {}
      location.reload(true);
    };
    var x = h("button",{style:"margin-left:8px;background:#333;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer;"},"Cerrar");
    x.onclick=function(){ bar.remove(); };
    bar.appendChild(msg); bar.appendChild(btn); bar.appendChild(x);
    document.body.appendChild(bar);
  }

  function same(a,b){return String(a||"").trim()===String(b||"").trim();}

  fetch("/api/deploy-stamp",{credentials:"include"}).then(function(r){return r.json();}).then(function(j){
    var cur = (j && (j.stamp||j.commit||"")) || "";
    var prev = ""; try { prev = localStorage.getItem("deployStamp")||""; } catch(_) {}
    if(!same(cur, prev) && cur){ show(cur); }
  }).catch(function(_e){ /* silencioso */ });
})();
</script>
\n