<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Notas</title>
<style>
  :root{
    --bg:#fffdfc; --fg:#24323f; --muted:#6b7a86;
    --teal:#8fd3d0;   /* turquesa pastel */
    --peach:#ffb38a;  /* naranja pastel */
    --pink:#f9a3c7;   /* rosa pastel */
    --card:#ffffff; --ring: rgba(36,50,63,.15);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg),#fff);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--teal),var(--peach),var(--pink));color:#17323a;padding:16px 20px;box-shadow:0 2px 12px var(--ring)}
  h1{margin:0;font-size:clamp(20px,3.2vw,28px)}
  .container{max-width:860px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #eee;border-radius:16px;padding:14px;box-shadow:0 4px 20px var(--ring)}
  textarea,input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e6eef2;outline:none;font-size:16px;background:#fff;color:var(--fg)}
  textarea:focus,input:focus{border-color:#b5dfe0;box-shadow:0 0 0 4px rgba(143,211,208,.25)}
  .row{display:flex;gap:10px;margin-top:10px}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;background:linear-gradient(90deg,var(--teal),var(--peach));color:#14333a;box-shadow:0 6px 18px var(--ring)}
  .btn:active{transform:translateY(1px)}
  .list{margin-top:18px;display:grid;gap:12px}
  .note{background:#fff;border:1px solid #eef2f5;border-radius:14px;padding:12px 14px}
  .note .meta{color:var(--muted);font-size:12px;margin-top:6px;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .actions{display:flex;gap:8px;align-items:center}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #e7edf1;background:#fff}
  .iconbtn{border:0;background:#fff;border:1px solid #e7edf1;border-radius:999px;padding:6px 10px;cursor:pointer}
  .iconbtn:active{transform:translateY(1px)}
  details.menu{margin-left:auto}
  details.menu summary{list-style:none;cursor:pointer}
  details.menu[open] summary{opacity:.8}
  footer{margin:40px 0 28px;color:var(--muted);text-align:center;font-size:14px}
  footer a{color:#0b7c8a;text-decoration:underline}
  .hidden{display:none}
  .error{color:#9a2b2b;margin-top:8px}
  .ok{color:#0a6f57;margin-top:8px}
  mark{background:rgba(249,163,199,.35);padding:0 .25em;border-radius:6px}
</style>
</head>
<body>
  <header><h1>Notas</h1></header>
  <main class="container">
    <section class="card">
      <label for="text" style="font-weight:600;">Escribe tu nota‚Ä¶</label>
      <textarea id="text" rows="3" placeholder="Escribe tu nota‚Ä¶"></textarea>
      <div class="row">
        <input id="ttl" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Horas (12 por defecto)">
        <button id="send" class="btn">Publicar</button>
      </div>
      <div id="msg" class="hidden"></div>
    </section>

    <section class="list" id="list"></section>

    <footer>
      <span>Usamos cookies/localStorage (p. ej., para contar vistas).</span><br/>
      <a href="/terms">T√©rminos y Condiciones</a> ¬∑
      <a href="/privacy">Pol√≠tica de Privacidad</a>
    </footer>
  </main>

<script>
const $ = (s)=>document.querySelector(s);
const api = (p)=> (p.startsWith('/')?p:'/api/'+p);
function esc(s){return (s||'').replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]))}
function fmtDate(iso){try{ return new Date(iso).toLocaleString(); }catch(_){ return iso }}

function notePermalink(id){ return location.origin + '/?id=' + id }
function chip(lbl,val){ return '<span class="chip">'+lbl+' '+val+'</span>' }

function renderItem(it, highlightId){
  const text = it.text || it.content || it.summary || '';
  const hlStart = (it.id==highlightId) ? '<mark>' : '';
  const hlEnd   = (it.id==highlightId) ? '</mark>' : '';
  return `
    <article class="note" data-id="${it.id}">
      <div>${hlStart}${esc(text)||'(sin texto)'}${hlEnd}</div>
      <div class="meta">
        <span>#${it.id ?? '-'}</span>
        <span>${fmtDate(it.timestamp)}</span>
        <span class="counters">${chip('‚ù§', it.likes ?? 0)} ${chip('üëÅÔ∏è', it.views ?? 0)} ${chip('üö©', it.reports ?? 0)}</span>
        <div class="actions">
          <button class="iconbtn like">‚ù§ Me gusta</button>
          <button class="iconbtn share">üîó Compartir</button>
          <details class="menu">
            <summary class="iconbtn">‚ãØ</summary>
            <div class="card" style="position:relative;margin-top:8px;padding:8px">
              <button class="iconbtn open">üëÅÔ∏è Ver enlace</button>
              <button class="iconbtn copy">üìã Copiar enlace</button>
              <button class="iconbtn report">üö© Reportar</button>
            </div>
          </details>
        </div>
      </div>
    </article>
  `;
}

function renderList(items, highlightId){
  $('#list').innerHTML = (items||[]).map(it=>renderItem(it, highlightId)).join('') || '<div class="note">No hay notas a√∫n.</div>';
  wireEvents();
  autoView();
}

async function load(highlightId){
  try{
    const r = await fetch(api('notes'), {headers:{'Accept':'application/json'}});
    const j = await r.json();
    const items = Array.isArray(j)? j : (j.items || []);
    renderList(items, highlightId);
    if(highlightId){
      const el = document.querySelector('[data-id="'+highlightId+'"]');
      if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); }
    }
  }catch(e){
    $('#list').innerHTML = '<div class="note">Error cargando notas.</div>';
  }
}

function flash(msg, ok){
  const el = $('#msg');
  el.className = ok ? 'ok' : 'error';
  el.textContent = msg;
  setTimeout(()=>{ el.className='hidden'; el.textContent=''; }, 2000);
}

async function publish(){
  const text = $('#text').value.trim();
  const ttlh = parseInt($('#ttl').value.trim()||'');
  if(!text){ flash('Escrib√≠ algo antes de publicar', false); return }
  try{
    const body = { text };
    if(Number.isFinite(ttlh) && ttlh>0) body.ttl_hours = ttlh;
    const r = await fetch(api('notes'), {
      method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error || 'error');
    $('#text').value=''; $('#ttl').value=''; flash('Publicado ‚úÖ', true);
    // prepend la nueva nota
    const it = j.item;
    const cur = $('#list').innerHTML;
    $('#list').innerHTML = renderItem(it) + cur;
    wireEventsFor(document.querySelector('[data-id="'+it.id+'"]'));
  }catch(e){ console.error(e); flash('No se pudo publicar', false); }
}

function wireEvents(){
  document.querySelectorAll('.note').forEach(wireEventsFor);
}
function wireEventsFor(el){
  const id = el.getAttribute('data-id');
  el.querySelector('.like')?.addEventListener('click', async ()=>{
    const r = await fetch(api(`notes/${id}/like`), {method:'POST'}); const j = await r.json();
    if(j.ok){ updateCounters(el, j); }
  });
  el.querySelector('.report')?.addEventListener('click', async ()=>{
    const r = await fetch(api(`notes/${id}/report`), {method:'POST'}); const j = await r.json();
    if(j.ok){ updateCounters(el, j); flash('Reportado', true); }
  });
  el.querySelector('.share')?.addEventListener('click', ()=>doShare(id));
  el.querySelector('.open')?.addEventListener('click', ()=>window.open(notePermalink(id),'_blank'));
  el.querySelector('.copy')?.addEventListener('click', ()=>copyLink(id));
}

function updateCounters(el, data){
  const cnt = el.querySelector('.counters');
  cnt.innerHTML = `${chip('‚ù§', data.likes ?? 0)} ${chip('üëÅÔ∏è', data.views ?? 0)} ${chip('üö©', data.reports ?? 0)}`;
}

async function doShare(id){
  const url = notePermalink(id);
  const text = 'Mir√° esta nota #' + id;
  try{
    if(navigator.share){ await navigator.share({title:'Nota #'+id,text,url}); return; }
  }catch(_){}
  await copyToClipboard(url);
  flash('Enlace copiado', true);
}
async function copyLink(id){
  await copyToClipboard(notePermalink(id));
  flash('Enlace copiado', true);
}
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); }
  catch(_){
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
}

// Cuenta una vista cuando la nota entra al viewport (una sola vez)
function autoView(){
  const once = new WeakSet();
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(async (e)=>{
      if(e.isIntersecting){
        const el = e.target; if(once.has(el)) return;
        once.add(el);
        const id = el.getAttribute('data-id');
        try{
          const r = await fetch(api(`notes/${id}/view`), {method:'POST'});
          const j = await r.json();
          if(j.ok){ updateCounters(el, j); }
        }catch(_){}
      }
    });
  }, { rootMargin: '0px 0px -20% 0px', threshold: 0.2 });
  document.querySelectorAll('.note').forEach(n=>io.observe(n));
}

$('#send').addEventListener('click', publish);
$('#text').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ publish(); }});

window.addEventListener('DOMContentLoaded', ()=>{
  const u = new URL(location.href);
  const pre = u.searchParams.get('text'); if(pre){ $('#text').value = pre; }
  const highlightId = parseInt(u.searchParams.get('id')||'');
  load(Number.isFinite(highlightId)? highlightId : undefined);
});
</script>
</body>
</html>
