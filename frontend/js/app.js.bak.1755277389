class NotesApp {
  constructor() {
    this.list   = document.getElementById("notes");
    this.pagNav = document.getElementById("pagination");
    this.form   = document.getElementById("form");
    this.page   = 1;
    this.pages  = 1;
    this.seen   = new Set();
    this.token = localStorage.getItem('p12_token');
    if(!this.token){
      try{ this.token = crypto.randomUUID(); }except(e){ this.token = Math.random().toString(36).slice(2)+Date.now().toString(36); }
      localStorage.setItem('p12_token', this.token);
    } // para contar vistas solo una vez por render

    this.bindEvents();
    this.load(1);
  }

  bindEvents() {
    if (this.form) {
      this.form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const textarea = this.form.querySelector("textarea");
        const text = (textarea?.value || "").trim();

        // select puede llamarse expire_hours o duration; tomamos lo que exista
        const sel = this.form.querySelector("[name=expire_hours]") ||
                    this.form.querySelector("#duration");
        let hours = parseInt(sel?.value ?? "168", 10);
        if (!Number.isFinite(hours) || hours < 1 || hours > 24*28) hours = 168;

        const r = await fetch("/api/notes", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ text, expire_hours: hours })
        });
        if (r.ok) {
          if (textarea) textarea.value = "";
          this.load(1);
        } else {
          const err = await r.json().catch(()=>({error:"Error"}));
          alert(err.error || "Error al publicar");
        }
      });
    }

    // Delegación para clicks de "Like"
    this.list?.addEventListener("click", async (e) => {
      const btn = e.target.closest(".like-btn");
      if (!btn) return;
      const li = btn.closest("li[data-id]");
      const id = li?.dataset.id;
      if (!id) return;

      const r = await fetch(`/api/notes/${id}/like`, { method:'POST', headers:{'X-Client-Token': this.token} });
      if (r.ok) {
        const { likes } = await r.json();
        const el = li.querySelector(".likes-count");
        if (el) el.textContent = likes;
      }
    });
  }

  async load(page=1) {
    this.page = page;
    const r = await fetch(`/api/notes?page=${page}`);
    const j = await r.json();
    this.pages = j.total_pages || 1;
    this.render(j.notes || []);
  }

  render(items) {
    this.list.innerHTML = items.map(n => `
      <li class="note" data-id="${n.id}">
        <div class="note-text">${this.escape(n.text)}</div>
        <div class="note-meta">
          <button type="button" class="like-btn">❤️ Like</button>
          <span class="counters">👍 <span class="likes-count">${n.likes||0}</span> ·
          👁️ <span class="views-count">${n.views||0}</span></span>
        </div>
      </li>
    `).join("");

    // Paginación
    this.pagNav.innerHTML = "";
    for (let p = 1; p <= this.pages; p++) {
      const b = document.createElement("button");
      b.textContent = p;
      if (p === this.page) b.disabled = true;
      b.addEventListener("click", () => this.load(p));
      this.pagNav.appendChild(b);
    }

    // Ping de vistas (una vez por nota por sesión de render)
    this.list.querySelectorAll("li[data-id]").forEach(li => {
      const id = li.dataset.id;
      if (this.seen.has(id)) return;
      this.seen.add(id);
      fetch(`/api/notes/${id}/view`, { method:'POST', headers:{'X-Client-Token': this.token} })
        .then(r => r.json())
        .then(j => {
          const el = li.querySelector(".views-count");
          if (el && j && typeof j.views === "number") el.textContent = j.views;
        }).catch(()=>{});
    });
  }

  escape(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML.replace(/\n/g, "<br>");
  }
}

document.addEventListener("DOMContentLoaded", () => new NotesApp());
