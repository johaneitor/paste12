<!doctype html>
<html lang="es">
<head>
  <meta name="ads-client" content="ca-pub-XXXXXXXXXXXXXXX">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>paste12</title>
  <link rel="stylesheet" href="/css/styles.css">
  <!-- Ads (s√≥lo cambia tu client y slot cuando tengas el ID) -->
  <link rel="preconnect" href="https://pagead2.googlesyndication.com">
  <link rel="preconnect" href="https://googleads.g.doubleclick.net">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
</head>
<body>
  <header class="topbar">
    <h1 style="margin:0">Notas</h1>
  </header>

  <!-- Bloque de anuncio responsivo -->
  <section class="adwrap" style="max-width:860px;margin:12px auto">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </section>

  <main class="container">
    <form id="noteForm" style="display:grid;gap:8px;margin-top:8px">
      <textarea name="text" placeholder="Escribe tu nota‚Ä¶" required></textarea>
      <input type="number" id="hours" name="hours" value="24" min="1" max="720">
      <button type="submit">Publicar</button>
      <span id="status"></span>
    </form>
    <ul id="notes" style="list-style:none;padding:0;margin:16px 0"></ul>
    <section id="ad-below-form" class="ad-slot"><!-- ad slot --></section>
  
  <button id="loadMore" class="load-more" style="display:none;margin:12px auto;padding:8px 14px;border:1px solid #253044;border-radius:10px;background:#0d1320;color:#eaf2ff">Cargar m√°s</button>

</main>
  <footer class="site">
    <a href="/terms.html">T√©rminos y Condiciones</a> ¬∑ <a href="/privacy.html">Pol√≠tica de Privacidad</a>
  </footer>

  <footer class="footer">
    <a href="/terms.html">T√©rminos</a> ¬∑
    <a href="/privacy.html">Privacidad</a>
  </footer>

  <!-- Consentimiento -->
  <div id="consent" class="consent is-hidden" aria-hidden="true"
       style="position:fixed;left:0;right:0;bottom:0;padding:10px 14px;display:flex;gap:10px;align-items:center;z-index:9998">
    Usamos cookies/localStorage (por ejemplo, para contar vistas y mostrar anuncios).
    Al continuar acept√°s nuestros <a href="/terms.html">T√©rminos</a> y
    <a href="/privacy.html">Pol√≠tica de Privacidad</a>.
    <button id="consentAccept" style="margin-left:auto">Aceptar</button>
  </div>

  <script src="/js/app.js?v=3"></script>
  <script>
  // Banner de consentimiento fiable
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var c = document.getElementById('consent');
      var b = document.getElementById('consentAccept');
      var has = (localStorage.getItem('consent') === '1');
      if (has) { c.classList.add('is-hidden'); c.setAttribute('hidden',''); c.setAttribute('aria-hidden','true'); }
      else     { c.classList.remove('is-hidden'); c.removeAttribute('hidden'); c.setAttribute('aria-hidden','false'); }
      b && b.addEventListener('click', function(){
        try{ localStorage.setItem('consent','1'); }catch(e){}
        c.classList.add('is-hidden'); c.setAttribute('hidden',''); c.setAttribute('aria-hidden','true');
      });
    }catch(e){}
  });
  </script>

<!-- p12 debug bootstrap -->
<script id="debug-bootstrap-p12">
(function () {
  try {
    var p = new URLSearchParams(location.search);
    if (!p.has('debug')) return;

    // 1) Desregistrar SW antiguos (no rompe si no hay)
    if ('serviceWorker' in navigator) {
      try {
        navigator.serviceWorker.getRegistrations().then(function(rs){
          rs.forEach(function(r){ r.unregister(); });
        });
      } catch (_e) {}
    }

    // 2) UI m√≠nima de diagn√≥stico
    function addBox() {
      var box = document.createElement('div');
      box.style.cssText = 'position:fixed;right:12px;bottom:12px;padding:10px 12px;background:#111;color:#fff;font:12px/1.4 system-ui;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.3);max-width:42ch;z-index:99999';
      box.innerHTML = '<b>p12 debug</b><div id="p12d"></div>';
      document.body.appendChild(box);
      return box.querySelector('#p12d');
    }
    function log(k,v){
      var el = document.createElement('div');
      el.textContent = k + ': ' + v;
      root.appendChild(el);
    }

    var root = addBox();

    // 3) checks r√°pidos
    fetch('/api/health').then(function(r){ log('health', r.status); }).catch(function(){ log('health','ERR'); });

    fetch('/api/deploy-stamp')
      .then(function(r){ return r.json(); })
      .then(function(j){
        var c = ((j && j.deploy && j.deploy.commit) || j.commit || '').slice(0,7);
        var d = ((j && j.deploy && j.deploy.date)   || j.date   || '');
        log('deploy', c + ' @ ' + d);
      })
      .catch(function(){ log('deploy','ERR'); });

    fetch('/api/notes?limit=3', {headers:{'Accept':'application/json'}})
      .then(function(r){ return r.json(); })
      .then(function(j){
        var n = (Array.isArray(j) ? j.length : ((j && j.items && j.items.length) || 0));
        log('notes', n + ' items');
      })
      .catch(function(){ log('notes','ERR'); });

  } catch (_e) {}
})();
</script>


<!-- p12 PE shim (solo ?pe=1) -->
<script id="pe-shim-p12">
(function(){
  try {
    var p = new URLSearchParams(location.search);
    if (!p.has('pe')) return;

    var root = document.createElement('div');
    root.style.cssText = 'margin:16px;padding:12px;border:1px dashed #aaa;border-radius:10px;background:#fafafa';
    root.innerHTML = '<b>PE shim</b> ‚Äî listado m√≠nimo de /api/notes';
    var list = document.createElement('div');
    list.style.cssText = 'margin-top:8px;font:14px system-ui';
    root.appendChild(list);
    (document.body || document.documentElement).appendChild(root);

    fetch('/api/notes?limit=5',{headers:{'Accept':'application/json'}})
      .then(function(r){ return r.json(); })
      .then(function(j){
        var items = (j && j.items) || [];
        if (!items.length) { list.textContent = '(sin items)'; return; }
        var ul = document.createElement('ul');
        items.forEach(function(it){
          var li = document.createElement('li');
          li.textContent = '#'+it.id+': '+(it.text || it.summary || '(sin texto)');
          ul.appendChild(li);
        });
        list.appendChild(ul);
      })
      .catch(function(){ list.textContent = 'error cargando'; });
  } catch (_e) {}
})();
</script>




<script id="p12-hotfix-v4">
(()=>{'use strict';
if (window.__P12_HOTFIX_V4__) return; window.__P12_HOTFIX_V4__=true;

const Q=new URLSearchParams(location.search);

// Apaga SW/banners si ?nosw=1 o ?debug=1
if((Q.has('nosw')||Q.has('debug')) && 'serviceWorker' in navigator){
  try{navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));}catch(e){}
  try{if(caches&&caches.keys) caches.keys().then(ks=>ks.forEach(k=>caches.delete(k)));}catch(e){}
}
(function killBanners(){
  const BAD=[/nueva versi√≥n disponible/i,/actualiza para ver/i,/update available/i];
  for(const el of Array.from(document.body.querySelectorAll('*'))){
    const t=(el.textContent||'').trim(); if(!t) continue;
    if(BAD.some(rx=>rx.test(t))){
      try{ el.closest('[role="alert"],.toast,.snackbar,.banner')?.remove(); }catch(_){}
      try{ el.remove(); }catch(_){}
    }
  }
})();

// ==== Helpers
const $=(s,c=document)=>c.querySelector(s);
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const esc=s=>(s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

// ==== Feed unificado
const FEED_SEL = '#list, .list, [data-notes], [data-feed], #notes, #feed';
let FEED = $(FEED_SEL);
if(!FEED){ FEED = document.createElement('section'); FEED.id='list'; (document.body||document.documentElement).appendChild(FEED); }

// ==== Flash
function flash(ok,msg){
  let el = $('#msg'); if(!el){ el=document.createElement('div'); el.id='msg'; (document.body||document.documentElement).prepend(el); }
  el.className = ok?'ok':'error'; el.textContent = msg;
  setTimeout(()=>{ el.className='hidden'; el.textContent=''; }, 2200);
}

// ==== Render
function cardHTML(it){
  const txt = it.text || it.content || it.summary || '';
  let short = txt, needMore=false;
  if (txt.length > 180){ short = txt.slice(0,160)+'‚Ä¶'; needMore=true; }
  return `
    <article class="note" data-id="${it.id}">
      <div data-text="1" data-full="${esc(txt)}">${esc(short)||'(sin texto)'}</div>
      <div class="meta">#${it.id} ¬∑ ‚ù§ ${it.likes??0} ¬∑ <span class=\"views\">üëÅ ${it.views??0}</span>
        <button class="act like" type="button">‚ù§</button>
        <button class="act more" type="button">‚ãØ</button>
      </div>
      <div class="menu hidden">
        ${needMore?'<button class="expand" type="button">Ver m√°s</button>':''}
        <button class="share"  type="button">Compartir</button>
        <button class="report" type="button">Reportar üö©</button>
      </div>
    </article>`;
}
function appendItems(items){
  if(!items||!items.length) return;
  const div=document.createElement('div');
  div.innerHTML = items.map(cardHTML).join('');
  FEED.append(...div.children);
}

// ==== Acciones delegadas (like/‚ãØ/share/report/ver m√°s)
document.addEventListener('click', async (e)=>{
  const art  = e.target.closest && e.target.closest('article.note');
  const id   = art && art.getAttribute('data-id');
  if(!art || !id) return;

  const like = e.target.closest('button.like');
  const more = e.target.closest('button.more');
  const share= e.target.closest('button.share');
  const rpt  = e.target.closest('button.report');
  const exp  = e.target.closest('button.expand');

  try{
    if(like){
      const r=await fetch(`/api/notes/${id}/like`,{method:'POST',credentials:'include'});
      const j=await r.json().catch(()=>({}));
      if(j && typeof j.likes!=='undefined'){
        const m=art.querySelector('.meta');
        if(m) m.innerHTML = m.innerHTML.replace(/‚ù§\s*\d+/, '‚ù§ '+j.likes);
      }
    }else if(more){
      art.querySelector('.menu')?.classList.toggle('hidden');
    }else if(share){
      const url = `${location.origin}/?id=${id}`;
      if(navigator.share){ await navigator.share({title:`Nota #${id}`, url}); }
      else { await navigator.clipboard.writeText(url); flash(true,'Link copiado'); }
      art.querySelector('.menu')?.classList.add('hidden');
    }else if(rpt){
      const r=await fetch(`/api/notes/${id}/report`,{method:'POST',credentials:'include'});
      const j=await r.json().catch(()=>({}));
      if(j?.removed){ art.remove(); flash(true,'Nota eliminada'); }
      else { flash(true,'Reporte enviado'); }
      art.querySelector('.menu')?.classList.add('hidden');
    }else if(exp){
      const box=art.querySelector('[data-text]'); if(!box) return;
      const full=box.getAttribute('data-full')||'';
      const expanded = exp.getAttribute('data-expanded')==='1';
      if(expanded){ box.textContent = (full.length>180? full.slice(0,160)+'‚Ä¶' : full); exp.textContent='Ver m√°s'; exp.setAttribute('data-expanded','0'); }
      else        { box.textContent = full; exp.textContent='Ver menos'; exp.setAttribute('data-expanded','1'); }
    }
  }catch(_){}
}, {capture:true});

// ==== Publicar (JSON con ttl_hours + fallback FORM)
function pickTextarea(){ return document.querySelector('textarea[name=text], #text, textarea'); }
function pickTTL(){ return document.querySelector('input[name=ttl_hours], #ttl, select[name=ttl_hours], select'); }
function validateText(s){ return (s||'').trim().length >= 12; }

async function publish(ev){
  ev && ev.preventDefault && ev.preventDefault();
  const ta = pickTextarea(); const ttl = pickTTL();
  const text=(ta?.value||'').trim();
  if(!validateText(text)){ flash(false,'Escrib√≠ un poco m√°s (‚â• 12 caracteres).'); return; }
  const body={ text }; const v=parseInt(ttl?.value||'',10); if(Number.isFinite(v) && v>0) body.ttl_hours=v;

  let r=null, j=null;
  try{ r=await fetch('/api/notes',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(body)}); }catch(_){}
  if(!r || !r.ok){
    const fd = new URLSearchParams(); fd.set('text', text); if(body.ttl_hours) fd.set('ttl_hours', String(body.ttl_hours));
    try{ r=await fetch('/api/notes',{method:'POST',credentials:'include',headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},body:fd}); }catch(_){}
  }
  try{ j=await r.json(); }catch(_){ j=null; }
  if(!r || !r.ok || !j || j.ok===false){ flash(false,(j&&j.error)||('Error HTTP '+(r&&r.status))); return; }

  // Prepend nuevo item
  const it = j.item || {id:j.id, text, likes:j.likes||0, views:0, timestamp:new Date().toISOString()};
  const wrap=document.createElement('div'); wrap.innerHTML=cardHTML(it);
  FEED.prepend(wrap.firstElementChild);
  if(ta) ta.value=''; if(ttl) ttl.value='';
  flash(true,'Publicado ‚úÖ');
}

// Bindeo de publicar (click + Ctrl/Cmd+Enter)
window.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('send'); if(btn){ btn.addEventListener('click', publish, {capture:true}); }
  const ta  = pickTextarea(); if(ta){ ta.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) publish(e);}); }
});

// ==== Paginaci√≥n keyset (Link / X-Next-Cursor) + bot√≥n √∫nico
let nextURL=null, loading=false, seen=new Set(Array.from(document.querySelectorAll('article.note[data-id]')).map(x=>x.getAttribute('data-id')));

function setMoreVisible(v){
  let b=document.getElementById('p12-more'); if(!b){
    b=document.createElement('button'); b.id='p12-more'; b.type='button';
    b.textContent='Cargar m√°s';
    b.style.cssText='display:block;margin:12px auto;padding:.6rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;';
    FEED.after(b);
    b.onclick=()=>{ if(nextURL && !loading) fetchPage(nextURL); };
  }
  b.style.display = v ? '' : 'none';
}

function parseNext(res){
  nextURL=null;
  const link = res.headers.get('Link') || res.headers.get('link');
  if(link){
    const m=/<([^>]+)>;\s*rel="?next"?/i.exec(link); if(m) nextURL=m[1];
  }
  if(!nextURL){
    try{
      const xn = JSON.parse(res.headers.get('X-Next-Cursor')||'null');
      if(xn && xn.cursor_ts && xn.cursor_id){
        nextURL = `/api/notes?cursor_ts=${encodeURIComponent(xn.cursor_ts)}&cursor_id=${xn.cursor_id}`;
      }
    }catch(_){}
  }
  setMoreVisible(!!nextURL);
}

async function fetchPage(url){
  loading=true;
  try{
    const r=await fetch(url,{headers:{'Accept':'application/json'},credentials:'include'});
    const j=await r.json().catch(()=>({}));
    const items=(Array.isArray(j)?j:(j.items||[])).filter(it=>!seen.has(String(it.id)));
    items.forEach(it=>seen.add(String(it.id)));
    appendItems(items);
    parseNext(r);
  }catch(_){
    // en error ocultamos el bot√≥n para no confundir
    setMoreVisible(false);
  }finally{ loading=false; }
}

// Arranque: pag1
window.addEventListener('DOMContentLoaded', ()=>{
  const q=new URLSearchParams(location.search);
  const pid=q.get('id');
  if(pid){
    (async()=>{
      try{
        const r=await fetch(`/api/notes/${encodeURIComponent(pid)}`,{headers:{'Accept':'application/json'},credentials:'include'});
        const j=await r.json().catch(()=>({}));
        const it=j&&j.item; const root=document.querySelector('#list,.list,[data-feed],#feed')||document.body;
        if(it){ root.innerHTML = (function(){const d=document.createElement('div'); d.innerHTML=cardHTML(it); return d.innerHTML;})();
                 document.title = `Nota #${it.id} ‚Äì Paste12`; }
        else { root.innerHTML = '<article class="note"><div>(Nota no encontrada)</div></article>'; }
        const back=document.createElement('a'); back.href='/'; back.textContent='‚Üê Volver al feed';
        back.className='btn'; back.style.margin='12px auto'; root.after(back);
      }catch(_){}
    })();
    return; // no cargues el feed
  }
  fetchPage('/api/notes?limit=10');
});})();
</script>
<style>/* oculta banners SW de versi√≥n */#deploy-stamp-banner{display:none!important}</style>
<!-- P12 CONSOLIDATED HOTFIX v6 (safe, idempotent) -->
<script>
(function(){ 'use strict';
if (window.__P12_V6__) return; window.__P12_V6__ = true;

// ===== util =====
const Q = new URLSearchParams(location.search);
const $  = (s, c=document)=>c.querySelector(s);
const $$ = (s, c=document)=>Array.from(c.querySelectorAll(s));
const esc = s => (s??'').toString().replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

// ===== desregistrar SW / ocultar banners si se pide =====
if ((Q.has('nosw') || Q.has('debug')) && 'serviceWorker' in navigator){
  try{ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); }catch(_){}
  try{ if (window.caches && caches.keys) caches.keys().then(ks=>ks.forEach(k=>caches.delete(k))); }catch(_){}
}
// matar banners de "nueva versi√≥n disponible"
(function(){
  const BAD=[/nueva\s+vers/i,/update\s+available/i,/actualiza/i];
  for(const el of Array.from(document.body.querySelectorAll('*'))){
    const txt=(el.textContent||'').trim();
    if(!txt) continue;
    if(BAD.some(rx=>rx.test(txt))){
      try{ el.closest('[role="alert"],.toast,.snackbar,.banner')?.remove(); }catch(_){}
      try{ el.remove(); }catch(_){}
    }
  }
})();
(function(){ // oculta alg√∫n id com√∫n si existiera
  const s=document.createElement('style'); s.textContent = "#deploy-stamp-banner{display:none!important}";
  document.head.appendChild(s);
})();

// ===== FEED destino =====
const FEED_SEL = '#list, .list, [data-notes], [data-feed], #notes, #feed';
let FEED = $(FEED_SEL);
if (!FEED){ FEED = document.createElement('section'); FEED.id='list'; (document.body||document.documentElement).appendChild(FEED); }

// ===== flash =====
function flash(ok,msg){
  let el = $('#msg'); if(!el){ el=document.createElement('div'); el.id='msg'; (document.body||document.documentElement).prepend(el); }
  el.className = ok?'ok':'error'; el.textContent = msg;
  setTimeout(()=>{ el.className='hidden'; el.textContent=''; }, 2500);
}

// ===== render cards =====
function cardHTML(it){
  const txt = it.text || it.content || it.summary || '';
  const v   = Number.isFinite(it.views)? it.views : (typeof it.views==='number'? it.views : 0);
  const l   = Number.isFinite(it.likes)? it.likes : (typeof it.likes==='number'? it.likes : 0);
  let short = txt, needMore=false;
  if ((txt||'').length > 180){ short = txt.slice(0,160)+'‚Ä¶'; needMore=true; }
  return `
    <article class="note" data-id="${it.id}">
      <div data-text="1" data-full="${esc(txt)}">${esc(short)||'(sin texto)'}</div>
      <div class="meta">#${it.id} ¬∑ ‚ù§ ${l} ¬∑ <span class="views">üëÅ ${v}</span>
        <button class="act like" type="button">‚ù§</button>
        <button class="act more" type="button">‚ãØ</button>
      </div>
      <div class="menu hidden">
        ${needMore?'<button class="expand" type="button">Ver m√°s</button>':''}
        <button class="share"  type="button">Compartir</button>
        <button class="report" type="button">Reportar üö©</button>
      </div>
    </article>`;
}
function appendItems(items){
  if(!items||!items.length) return;
  const wrap=document.createElement('div');
  wrap.innerHTML = items.map(cardHTML).join('');
  FEED.append(...wrap.children);
}

// ===== acciones delegadas =====
document.addEventListener('click', async (e)=>{
  const art  = e.target.closest && e.target.closest('article.note');
  const id   = art && art.getAttribute('data-id');
  if(!art || !id) return;

  const like = e.target.closest('button.like');
  const more = e.target.closest('button.more');
  const share= e.target.closest('button.share');
  const rpt  = e.target.closest('button.report');
  const exp  = e.target.closest('button.expand');

  try{
    if(like){
      const r=await fetch(`/api/notes/${id}/like`,{method:'POST',credentials:'include'});
      const j=await r.json().catch(()=>({}));
      if (j && typeof j.likes!=='undefined'){
        const m=art.querySelector('.meta');
        if(m) m.innerHTML = m.innerHTML.replace(/‚ù§\s*\d+/, '‚ù§ '+j.likes);
      }
    }else if(more){
      art.querySelector('.menu')?.classList.toggle('hidden');
    }else if(share){
      const url = `${location.origin}/?id=${encodeURIComponent(id)}`;
      if(navigator.share){ try{ await navigator.share({title:`Nota #${id}`, url}); }catch(_){ /* noop */ } }
      else { try{ await navigator.clipboard.writeText(url); flash(true,'Link copiado'); }catch(_){} }
      art.querySelector('.menu')?.classList.add('hidden');
    }else if(rpt){
      const r=await fetch(`/api/notes/${id}/report`,{method:'POST',credentials:'include'});
      const j=await r.json().catch(()=>({}));
      if(j?.removed){ art.remove(); flash(true,'Nota eliminada'); }
      else { flash(true,'Reporte enviado'); }
      art.querySelector('.menu')?.classList.add('hidden');
    }else if(exp){
      const box=art.querySelector('[data-text]'); if(!box) return;
      const full=box.getAttribute('data-full')||'';
      const expanded = exp.getAttribute('data-expanded')==='1';
      if(expanded){ box.textContent = (full.length>180? full.slice(0,160)+'‚Ä¶' : full); exp.textContent='Ver m√°s'; exp.setAttribute('data-expanded','0'); }
      else        { box.textContent = full; exp.textContent='Ver menos'; exp.setAttribute('data-expanded','1'); }
    }
  }catch(_){}
}, {capture:true});

// ===== publicar =====
function pickTextarea(){ return document.querySelector('textarea[name=text], #text, textarea'); }
function pickTTL(){ return document.querySelector('input[name=ttl_hours], #ttl, select[name=ttl_hours], select'); }
function validateText(s){ return (s||'').trim().length >= 12; }

async function publish(ev){
  ev && ev.preventDefault && ev.preventDefault();
  const ta = pickTextarea(); const ttl = pickTTL();
  const text=(ta?.value||'').trim();
  if(!validateText(text)){ flash(false,'Escrib√≠ un poco m√°s (‚â• 12 caracteres).'); return; }
  const body={ text }; const v=parseInt(ttl?.value||'',10); if(Number.isFinite(v) && v>0) body.ttl_hours=v;

  let r=null, j=null;
  try{
    r=await fetch('/api/notes',{
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify(body)
    });
  }catch(_){}
  // fallback a FORM urlencoded si el backend responde 4xx/5xx (text_required, etc.)
  if(!r || !r.ok){
    const fd = new URLSearchParams(); fd.set('text', text); if(body.ttl_hours) fd.set('ttl_hours', String(body.ttl_hours));
    try{
      r=await fetch('/api/notes',{
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
        body:fd
      });
    }catch(_){}
  }
  try{ j = await r.json(); }catch(_){ j=null; }
  if(!r || !r.ok || !j || j.ok===false){ flash(false,(j&&j.error)||('Error HTTP '+(r&&r.status))); return; }

  const it = j.item || {id:j.id, text, likes:j.likes||0, views:0, timestamp:new Date().toISOString()};
  const wrap=document.createElement('div'); wrap.innerHTML=cardHTML(it);
  FEED.prepend(wrap.firstElementChild);
  if(ta) ta.value=''; if(ttl) ttl.value='';
  flash(true,'Publicado ‚úÖ');
}

window.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('send'); if(btn){ btn.addEventListener('click', publish, {capture:true}); }
  const ta  = pickTextarea(); if(ta){ ta.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)) publish(e);}); }
});

// ===== vistas (IO + fallback por click)
(function(){
  const seen = new Set();
  try{ (JSON.parse(localStorage.getItem('seen_views')||'[]')||[]).slice(-500).forEach(id=>seen.add(String(id))); }catch(_){}
  const save = ()=>{ try{ localStorage.setItem('seen_views', JSON.stringify([...seen].slice(-500))); }catch(_){} };

  const io = new IntersectionObserver((ents)=>{
    ents.forEach(async (ent)=>{
      if(!ent.isIntersecting) return;
      const el=ent.target, id=(el.getAttribute('data-id')||'').trim(); if(!id || seen.has(id)) { io.unobserve(el); return; }
      seen.add(id); save();
      try{
        const r=await fetch(`/api/notes/${id}/view`,{method:'POST',credentials:'include'});
        const j=await r.json().catch(()=>({}));
        if(r.ok && (j.ok || j.id)){
          const span = el.querySelector('.views');
          if(span){ const m=/(\d+)/.exec(span.textContent||'0'); const cur=m?parseInt(m[1],10):0; span.textContent='üëÅ '+(cur+1); }
        }
      }catch(_){}
      io.unobserve(el);
    });
  }, {root:null, threshold:0.2, rootMargin:'0px 0px -20% 0px'});

  function attach(){
    document.querySelectorAll('article.note[data-id]').forEach(el=>{
      if(!el.dataset._io){ el.dataset._io='1'; io.observe(el); }
      // fallback por click (primera interacci√≥n)
      if(!el.dataset._viewClick){
        el.dataset._viewClick='1';
        el.addEventListener('pointerdown', ()=>{
          const id=(el.getAttribute('data-id')||'').trim(); if(!id || seen.has(id)) return;
          seen.add(id); save();
          fetch(`/api/notes/${id}/view`,{method:'POST',credentials:'include'}).catch(()=>{});
        }, {once:true, capture:true});
      }
    });
  }
  const list = FEED; if(list){ new MutationObserver(attach).observe(list,{childList:true}); }
  attach();
})();

// ===== paginaci√≥n keyset (Link/X-Next-Cursor)
let nextURL=null, loading=false, seenIds=new Set(Array.from(document.querySelectorAll('article.note[data-id]')).map(x=>x.getAttribute('data-id')));

function setMoreVisible(v){
  let b=document.getElementById('p12-more'); if(!b){
    b=document.createElement('button'); b.id='p12-more'; b.type='button';
    b.textContent='Cargar m√°s';
    b.style.cssText='display:block;margin:12px auto;padding:.6rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;';
    FEED.after(b);
    b.onclick=()=>{ if(nextURL && !loading) fetchPage(nextURL); };
  }
  b.style.display = v ? '' : 'none';
}
function parseNext(res){
  nextURL=null;
  const link = res.headers.get('Link') || res.headers.get('link');
  if(link){
    const m=/<([^>]+)>;\s*rel="?next"?/i.exec(link); if(m) nextURL=m[1];
  }
  if(!nextURL){
    try{
      const xn = JSON.parse(res.headers.get('X-Next-Cursor')||'null');
      if(xn && xn.cursor_ts && xn.cursor_id){
        nextURL = `/api/notes?cursor_ts=${encodeURIComponent(xn.cursor_ts)}&cursor_id=${xn.cursor_id}`;
      }
    }catch(_){}
  }
  setMoreVisible(!!nextURL);
}
async function fetchPage(url){
  loading=true;
  try{
    const r=await fetch(url,{headers:{'Accept':'application/json'},credentials:'include'});
    const j=await r.json().catch(()=>({}));
    const items=(Array.isArray(j)?j:(j.items||[])).filter(it=>!seenIds.has(String(it.id)));
    items.forEach(it=>seenIds.add(String(it.id)));
    appendItems(items);
    parseNext(r);
  }catch(_){
    setMoreVisible(false);
  }finally{ loading=false; }
}

// ===== modo ‚Äúnota √∫nica‚Äù (?id=123)
window.addEventListener('DOMContentLoaded', ()=>{
  const id = Q.get('id');
  if(id){
    (async()=>{
      try{
        const r=await fetch(`/api/notes/${encodeURIComponent(id)}`,{headers:{'Accept':'application/json'},credentials:'include'});
        const j=await r.json().catch(()=>({}));
        const it=j&&j.item; const root=FEED||document.body;
        if(it){
          root.innerHTML = (function(){const d=document.createElement('div'); d.innerHTML=cardHTML(it); return d.innerHTML;})();
          document.title = `Nota #${it.id} ‚Äì Paste12`;
          // flags para smokes y SEO
          try{
            document.documentElement.setAttribute('data-single-note','1');
            const m=document.createElement('meta'); m.name='p12-single'; m.content='1'; document.head.appendChild(m);
          }catch(_){}
        }else{
          root.innerHTML = '<article class="note"><div>(Nota no encontrada)</div></article>';
        }
        const back=document.createElement('a'); back.href='/'; back.textContent='‚Üê Volver al feed';
        back.className='btn'; back.style.margin='12px auto'; root.after(back);
      }catch(_){}
    })();
    return; // no cargar feed
  }
  // arranque normal: primera p√°gina
  fetchPage('/api/notes?limit=10');
});
})();
</script>

<!-- /P12 CONSOLIDATED HOTFIX v6 -->
<script id="p12-cohesion-v7">
(function(){
  if(window.__P12_V7_INIT) return; window.__P12_V7_INIT=1;
  const QS = new URLSearchParams(location.search);
  if(QS.has("nosw") && navigator.serviceWorker){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{}); }
  const FEED = document.getElementById("feed") || document.querySelector("[data-feed]") || (function(){ const m=document.createElement("main"); m.id="feed"; document.body.appendChild(m); return m; })();
  const BTN_MORE = document.getElementById("load-more") || (function(){ const b=document.createElement("button"); b.id="load-more"; b.textContent="Ver m√°s"; b.style.display="none"; document.body.appendChild(b); return b; })();
  let nextHref=null;
  function getNextFromHeaders(h){ const link=(h.get? h.get("Link"):null)||""; const m=/<([^>]+)>;\s*rel=\"next\"/i.exec(link); return m? m[1]:null; }
  async function apiList(url){ const r=await fetch(url,{credentials:"include"}); const j=await r.json(); if(!r.ok) throw new Error(j.error||"list_fail"); nextHref=getNextFromHeaders(r.headers)||null; return j.items||[]; }
  async function apiCreate(text){ text=(text||"").trim(); if(text.length<12) throw new Error("text_required");
    try{ const r=await fetch("/api/notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text})}); if(r.ok) return (await r.json()).item;
    }catch(_){}
    const fd=new URLSearchParams(); fd.set("text", text);
    const r2=await fetch("/api/notes",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:fd.toString()}); if(!r2.ok) throw new Error("create_fail"); return (await r2.json()).item; }
  async function apiAct(id,act){ const r=await fetch(`/api/notes/${id}/${act}`,{method:"POST"}); return r.json(); }
  function noteHTML(o){ const esc=s=>String(s||"").replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    return `<article class="note" data-id="${o.id}">`+
      `<div class="text">${esc(o.text)}</div>`+
      `<div class="meta"><button class="btn-like" data-act="like">‚ù§Ô∏è ${o.likes||0}</button>`+
      `<button class="btn-view" data-act="view">üëÅÔ∏è ${o.views||0}</button>`+
      `<button class="btn-share" data-act="share">üîó Compartir</button>`+
      `<button class="btn-report" data-act="report">üö© Reportar</button></div>`+`</article>`;
  }
  function appendItems(items){ const frag=document.createDocumentFragment(); items.forEach(o=>{ const d=document.createElement("div"); d.innerHTML=noteHTML(o); frag.appendChild(d.firstElementChild); }); FEED.appendChild(frag); rehookIO(); }
  FEED.addEventListener("click", async (ev)=>{ const b=ev.target.closest("button[data-act]"); if(!b) return; const a=b.dataset.act; const art=b.closest("article.note"); const id=art?.dataset.id; if(!id) return;
    if(a==="share"){ const u=`${location.origin}/?id=${id}`; navigator.clipboard&&navigator.clipboard.writeText(u).catch(()=>{}); alert("Enlace copiado:\n"+u); return; }
    const j=await apiAct(id,a); if(j && art){ const like=art.querySelector(".btn-like"); const view=art.querySelector(".btn-view"); if(like) like.innerHTML=`‚ù§Ô∏è ${j.likes??0}`; if(view) view.innerHTML=`üëÅÔ∏è ${j.views??0}`; }
  });
  let IO=null; function rehookIO(){ if(IO) IO.disconnect(); IO=new IntersectionObserver(es=>{ es.forEach(e=>{ const a=e.target; if(e.isIntersecting && !a.__v){ a.__v=1; const id=a.dataset.id; apiAct(id,"view").then(j=>{ const v=a.querySelector(".btn-view"); if(v) v.innerHTML=`üëÅÔ∏è ${j.views??0}`; }).catch(()=>{}); } }); },{threshold:0.5}); document.querySelectorAll("article.note").forEach(n=>IO.observe(n)); window.__P12_V7_IO=IO; }
  async function loadFirst(){ const items=await apiList("/api/notes?limit=10"); appendItems(items); BTN_MORE.style.display = nextHref? "block":"none"; }
  BTN_MORE.addEventListener("click", async ()=>{ if(!nextHref) return; const items=await apiList(nextHref); appendItems(items); BTN_MORE.style.display = nextHref? "block":"none"; });
  // publish (si hay <form id="publish">)
  const PUB=document.getElementById("publish"); if(PUB){ PUB.addEventListener("submit", async (ev)=>{ ev.preventDefault(); const t=(PUB.querySelector("textarea, input[name=text]")||{}).value||""; try{ const it=await apiCreate(t); FEED.insertAdjacentHTML("afterbegin", noteHTML(it)); rehookIO(); PUB.reset&&PUB.reset(); }catch(e){ alert("No se pudo publicar"); } }); }
  async function single(){ const sid=QS.get("id")||QS.get("note"); if(!sid) return false; try{ const r=await fetch(`/api/notes/${sid}`); const j=await r.json(); if(!j.ok) return false; document.head.insertAdjacentHTML("beforeend","<meta name=\"p12-single\" content=\"1\">"); FEED.innerHTML=""; appendItems([j.item]); const back=document.createElement("a"); back.href="/"; back.textContent="‚Üê Volver al feed"; back.style.display="inline-block"; back.style.margin="12px 0"; FEED.prepend(back); BTN_MORE.style.display="none"; return true; }catch(_){ return false; } }
  (async function(){ if(!(await single())){ await loadFirst(); } })();
  // Marca visible para verificaci√≥n
  const mk=document.createElement("div"); mk.id="p12-v7-mark"; mk.textContent="P12 COHESION V7"; mk.style.position="fixed"; mk.style.bottom="-9999px"; mk.style.fontSize="0"; document.body.appendChild(mk);
})();
</script>
</body>
</html>
<!-- single-note shim (safe, idempotente) -->
<script id="single-note-shim">
</script>
